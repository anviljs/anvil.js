/*-----------------------------------------------------------------------------
 *	Anvil.JS v0.7.0
 *  Copyright (c) 2011-2012 Alex Robson
 *
 *	Permission is hereby granted, free of charge, to any person obtaining a 
 *	copy of this software and associated documentation files (the "Software"), 
 *	to deal in the Software without restriction, including without limitation 
 *	the rights to use, copy, modify, merge, publish, distribute, sublicense, 
 *	and/or sell copies of the Software, and to permit persons to whom the 
 *	Software is furnished to do so, subject to the following conditions:
 *
 *	The above copyright notice and this permission notice shall be included in 
 *	all copies or substantial portions of the Software.
 *
 *	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS 
 *	OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 *	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL 
 *	THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER 
 *	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING 
 *	FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER 
 *	DEALINGS IN THE SOFTWARE.
 *---------------------------------------------------------------------------*/
var Anvil,ArgParser,Combiner,Compiler,Configuration,Context,Continuous,FSCrawler,FSProvider,Host,Log,MarkupPipeline,MochaRunner,PostProcessor,Runner,Scheduler,SocketServer,SourcePipeline,StylePipeline,Suite,builder,coffeeKup,coffeeScript,colors,config,continuous,cssminifier,debug,defaultMocha,emitter,events,express,ext,extensionLookup,fs,gzipper,haml,inProcess,interfaces,jslint,jsp,less,libConfig,log,marked,mkdir,mocha,path,pro,quiet,reporters,siteConfig,stylus,test,version,_;events=require("events"),emitter=events.EventEmitter,_=require("underscore"),colors=require("colors"),fs=require("fs"),mkdir=require("mkdirp").mkdirp,path=require("path"),ArgParser=require("argparser"),express=require("express"),builder=require("DOMBuilder"),Log=function(){function a(){}return a.prototype.onEvent=function(a){if(!quiet)return console.log("   "+a)},a.prototype.onStep=function(a){if(!quiet)return console.log((""+a).blue)},a.prototype.onComplete=function(a){return console.log((""+a).green)},a.prototype.onError=function(a){return console.log(("!!! "+a+" !!!").red)},a}(),log=new Log,exports.log=log,_=require("underscore"),path=require("path"),config={},siteConfig={source:"src",style:"style",markup:"markup",output:{source:["lib","site/js"],style:["css","site/css"],markup:"site/"},spec:"spec",ext:"ext",lint:{},uglify:{},cssmin:{},gzip:{},hosts:{"/":"site"}},libConfig={source:"src",output:"lib",spec:"spec",ext:"ext",lint:{},uglify:{},gzip:{},hosts:{"/":"spec"}},defaultMocha={growl:!0,ignoreLeaks:!0,reporter:"spec",ui:"bdd",colors:!0},continuous=test=inProcess=quiet=debug=!1,version="0.8.0",ext={gzip:"gz",uglify:"min",cssmin:"min"},extensionLookup={".css":"style",".scss":"style",".sass":"style",".less":"style",".stylus":"style",".js":"source",".coffee":"source",".markdown":"markup",".md":"markup",".markdown":"markup",".html":"markup"},Configuration=function(){function a(a,b,c,d){this.fp=a,this.parser=b,this.scheduler=c,this.log=d}return a.prototype.configure=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;return l=this,this.parser.addValueOptions(["b","build","n","html","site","lib","libfile","sitefile"]),this.parser.parse(),c=this.parser.getOptions("b","build"),b=c?c:"./build.json",d=this.parser.getOptions("libfile"),e=this.parser.getOptions("sitefile"),continuous=this.parser.getOptions("ci"),g=this.parser.getOptions("h","host"),h=this.parser.getOptions("html"),p=this.parser.getOptions("mocha"),i=this.parser.getOptions("lib"),quiet=this.parser.getOptions("q","quiet"),m=this.parser.getOptions("v","version"),n=this.parser.getOptions("site"),m?(this.log.onEvent("Anvil.js "+version),a(config)):d||e?(j=d||(d=e),o=e?"site":"lib",this.writeConfig(o,""+j+".json",function(){return a(config)})):n||i?(console.log(""+n+" / "+i),o=n?"site":"lib",k=n||(n=i),config=o==="site"?siteConfig:libConfig,this.log.onStep("Creating scaffolding for new "+o+" project"),l.ensurePaths(function(){return l.writeConfig(o,k+"/build.json",function(){return l.log.onComplete("Scaffold "+k+" created!")})},k)):h?(config.genHtml=h,a(config)):(this.log.onStep("Checking for config..."),f=this.fp.pathExists(b),this.prepConfig(f,b,function(){return g&&(config.host=!0),continuous&&(config.continuous=!0),p&&(config.mocha=defaultMocha),l.ensurePaths(function(){return a(config)})}))},a.prototype.createLibBuild=function(){var a;if(buildLibTemplate)return a=buildLibTemplate===!0?"build.json":buildLibTemplate,writeConfig("lib",a),global.process.exit(0),config},a.prototype.createSiteBuild=function(){var a;if(buildSiteTemplate)return a=buildSiteTemplate===!0?"build.json":buildSiteTemplate,writeConfig("site",a),global.process.exit(0),config},a.prototype.ensurePaths=function(a,b){var c,d,e,f;return e=this,b=b||(b=""),config.working=config.working||"./tmp",c=this.fp,d=[config.source,config.style,config.markup,config.spec,config.ext,config.working],_.isObject(config.output)?d=d.concat(_.flatten(config.output)):d.push(config.output),f=function(a,d){try{return c.ensurePath([b,a],function(){return d()})}catch(e){return d()}},this.scheduler.parallel(d,f,function(){return e.copyPrereqs(a)})},a.prototype.prepConfig=function(a,b,c){var d,e;return e=this,d=function(){return e.normalizeConfig(c)},a?this.loadConfig(b,d):this.loadConvention(d)},a.prototype.loadConfig=function(a,b){var c;return this.log.onStep("Loading config..."),c=this.fp,c.read(a,function(a){return config=JSON.parse(a),config.extensions&&(ext.gzip=config.extensions.gzip||ext.gzip,ext.uglify=config.extensions.uglify||ext.uglify),b()})},a.prototype.loadConvention=function(a){var b;return b=this.fp.pathExists("./site")?siteConfig:libConfig,this.log.onStep("Loading convention..."),config=b,a()},a.prototype.normalizeConfig=function(a){var b,c,d,e,f,g;return f=this,d=this.fp,config.output=config.output||"lib",_.isString(config.output)&&(e=config.output,config.output={style:e,source:e,markup:e}),b=[],c=config.finalize,c&&b.push(function(a){return f.getFinalization(c,function(b){return config.finalize=b,a()})}),g=config.wrap,g&&b.push(function(a){return f.getWrap(g,function(b){return config.wrap=b,a()})}),config.mocha&&(config.mocha=_.extend(defaultMocha,config.mocha)),b.length>0?this.scheduler.parallel(b,function(a,b){return a(b)},function(){return a()}):a()},a.prototype.getFinalization=function(a,b){var c,d,e,f,g,h,i;return h=this,f={},g={},d={},c=this.scheduler.aggregate,!a||_.isEqual(a,{})?b(f):a.header||a["header-file"]||a.footer||a["footer-file"]?(this.getContentBlock(a,"header",d),this.getContentBlock(a,"footer",d),_.isEqual(d,{})?b(f):c(d,function(a){return f.source=a,b(f)})):(i={},e={source:a.source,style:a.style,markup:a.markup},_.each(e,function(a,b){var d;return d={},h.getContentBlock(a,"header",d),h.getContentBlock(a,"footer",d),i[b]=function(a){return c(d,a)}}),c(i,b))},a.prototype.getWrap=function(a,b){var c,d,e,f,g,h,i;return g=this,i={},f={},d={},c=this.scheduler.aggregate,!a||_.isEqual(a,{})?b(i):a.prefix||a["prefix-file"]||a.suffix||a["suffix-file"]?(this.getContentBlock(a,"prefix",d),this.getContentBlock(a,"suffix",d),_.isEqual(d,{})?b(finalization):c(d,function(a){return i.source=a,b(finalization)})):(h={},e={source:a.source,style:a.style,markup:a.markup},_.each(e,function(a,b){var d;return d={},g.getContentBlock(a,"prefix",d),g.getContentBlock(a,"suffix",d),h[b]=function(a){return c(d,a)}}),c(h,b))},a.prototype.getContentBlock=function(a,b,c){var d,e,f;c[b]=function(a){return a("")},d=this.fp;if(a){e=a[""+b+"-file"],f=a[b];if(e&&this.fp.pathExists(e))return c[b]=function(a){return d.read(e,function(b){return a(b)})};if(f)return c[b]=function(a){return a(f)}}},a.prototype.copyPrereqs=function(a){var b,c,d;return c=this.fp,b=this.scheduler.parallel,config.ext?(d=path.resolve(__dirname,"../ext"),c.getFiles(d,function(d){var e;return e=function(a,b){var d;return d=path.basename(a),c.pathExists([config.ext,d])?b():c.copy(a,[config.ext,d],b)},b(d,e,function(){return a()})})):a()},a.prototype.writeConfig=function(a,b,c){var d;return config=a==="lib"?libConfig:siteConfig,log=this.log,d=JSON.stringify(config,null,"	"),this.fp.write(b,d,function(){return log.onComplete(""+b+" created successfully!"),c()})},a}(),exports.configuration=Configuration,_=require("underscore"),Scheduler=function(){function a(){}return a.prototype.parallel=function(a,b,c){var d,e,f,g,h,i,j;(!a||a.length===0)&&c([]),d=a.length,g=[],e=function(a){d-=1,a&&g.push(a);if(d===0)return c(g)},j=[];for(h=0,i=a.length;h<i;h++)f=a[h],j.push(b(f,e));return j},a.prototype.pipeline=function(a,b,c){var d,e;return(a===void 0||!b||b.length===0)&&c(a||{}),e=function(c){var d;return d=b.shift(),d(a,c)},d=function(){},d=function(f){return a=f,b.length===0?c(f):e(d)},e(d)},a.prototype.aggregate=function(a,b){var c,d,e;return e={},d=function(){return _.chain(a).keys().all(function(a){return e[a]!==void 0}).value()},c=function(a){return function(c){e[a]=c;if(d())return b(e)}},_.each(a,function(a,b){var d;return d=c(b),a(d)})},a}(),exports.scheduler=Scheduler,fs=require("fs"),path=require("path"),_=require("underscore"),FSCrawler=function(){function a(a){this.scheduler=a,_.bindAll(this)}return a.prototype.crawl=function(a,b){var c,d,e;return e=this,c=[],d=this.scheduler.parallel,a&&a!==""?(a=path.resolve(a),fs.readdir(a,function(f,g){var h,i,j,k;if(!f&&g.length>0){i=[];for(j=0,k=g.length;j<k;j++)h=g[j],i.push(path.resolve(a,h));return e.classifyHandles(i,function(a,f){return c=c.concat(a),f.length>0?d(f,e.crawl,function(a){return c=c.concat(_.flatten(a)),b(c)}):b(c)})}return b(c)})):b(c)},a.prototype.classifyHandles=function(a,b){return a&&a.length>0?this.scheduler.parallel(a,this.classifyHandle,function(a){var c,d,e,f,g;d=[],c=[];for(f=0,g=a.length;f<g;f++)e=a[f],e.isDirectory?c.push(e.file):d.push(e.file);return b(d,c)}):b([],[])},a.prototype.classifyHandle=function(a,b){return fs.stat(a,function(c,d){return c?b({file:a,err:c}):b({file:a,isDirectory:d.isDirectory()})})},a}(),exports.crawler=FSCrawler,fs=require("fs"),_=require("underscore"),FSProvider=function(){function a(a,b){this.crawler=a,this.log=b,_.bindAll(this)}return a.prototype.buildPath=function(a){var b;return a?(b=a,_.isArray(a)&&(b=path.join.apply({},a)),b):""},a.prototype["delete"]=function(a,b){a=this.buildPath(a);if(this.pathExists(a))return fs.unlink(a,function(a){return b()})},a.prototype.ensurePath=function(a,b){return a=this.buildPath(a),path.exists(a,function(c){return c?b():mkdir(a,"0755",function(c){return c?log.onError("Could not create "+a+". "+c):b()})})},a.prototype.getFiles=function(a,b){var c;return a?(a=this.buildPath(a),c=[],this.crawler.crawl(a,b)):b([])},a.prototype.copy=function(a,b,c){var d,e;return a=this.buildPath(a),b=this.buildPath(b),d=void 0,e=fs.createWriteStream(b),(d=fs.createReadStream(a)).pipe(e),d.on("end",function(){return e&&e.destroySoon(),c()})},a.prototype.pathExists=function(a){return a=this.buildPath(a),path.existsSync(a)},a.prototype.read=function(a,b){return a=this.buildPath(a),fs.readFile(a,"utf8",function(c,d){return c?(log.onError("Could not read "+a+" : "+c),b("",c)):b(d)})},a.prototype.readSync=function(a){a=this.buildPath(a);try{return fs.readFileSync(a,"utf8")}catch(b){return log.onError("Could not read "+a+" : "+b),b}},a.prototype.transform=function(a,b,c,d){var e;return e=this,a=this.buildPath(a),c=this.buildPath(c),this.read(a,function(a){return b(a,function(a,b){return b?d(b):e.write(c,a,d)})})},a.prototype.write=function(a,b,c){return a=this.buildPath(a),fs.writeFile(a,b,"utf8",function(b){return b?(log.onError("Could not write "+a+" : "+b),c(b)):c()})},a}(),exports.fsProvider=FSProvider,coffeeScript=require("coffee-script"),less=require("less"),stylus=require("stylus"),haml=require("haml"),marked=require("marked"),marked.setOptions({sanitize:!1}),coffeeKup=require("coffeekup"),_=require("underscore"),Compiler=function(){function a(a,b){this.fp=a,this.log=b,_.bindAll(this)}return a.prototype.compile=function(a,b){var c,d,e;return e=this,ext=a.ext(),c=this.extensionMap[ext],d=a.name.replace(ext,c),log=this.log,this.fp.transform([a.workingPath,a.name],this.compilers[ext],[a.workingPath,d],function(c){return c?b(c):(a.name=d,b(a))})},a.prototype.extensionMap={".coffee":".js",".kup":".html",".less":".css",".styl":".css",".sass":".css",".scss":".css",".haml":".html",".md":".html",".markdown":".html"},a.prototype.compilers={".coffee":function(a,b){var c;try{return c=coffeeScript.compile(a,{bare:!0}),b(c)}catch(d){return b("",d)}},".less":function(a,b){try{return less.render(a,{},function(a,c){return b(c)})}catch(c){return b("",c)}},".sass":function(a,b){try{return b(a)}catch(c){return b("",c)}},".scss":function(a,b){try{return b(a)}catch(c){return b("",c)}},".styl":function(a,b){try{return stylus.render(a,{},function(a,c){return b(c,a)})}catch(c){return b("",c)}},".haml":function(a,b){var c;try{return c=haml.render(a),b(c)}catch(d){return b("",d)}},".md":function(a,b){try{return b(marked.parse(a))}catch(c){return b("",c)}},".markdown":function(a,b){try{return b(marked.parse(a))}catch(c){return b("",c)}},".kup":function(a,b){var c;try{return c=coffeeKup.compile(a,{})(),b(c)}catch(d){return b("",d)}}},a}(),exports.compiler=Compiler,_=require("underscore"),Combiner=function(){function a(a,b,c,d){this.fp=a,this.scheduler=b,this.findPatterns=c,this.replacePatterns=d}return a.prototype.combineList=function(a,b){var c,d,e,f,g;return g=this,f=this.scheduler.parallel,e=_.bind(function(b,c){return g.findImports(b,a,c)},this),d=_.bind(function(b,c){return g.findDependents(b,a,c)},this),c=_.bind(function(a,b){return g.combineFile(a,b,this)}),f(a,e,function(){var e,g,h;for(g=0,h=a.length;g<h;g++)e=a[g],d(e,a);return f(a,c,b)})},a.prototype.combineFile=function(a,b){var c,d,e,f;return f=this,e=this.scheduler.parallel,a.combined?b():(c=function(a,b){return f.combineFile(a,b)},d=a.imports,d&&d.length>0?e(d,c,function(){return f.combine(a,function(){return a.combined=!0,b()})}):f.combine(a,function(){return a.combined=!0,b()}))},a.prototype.findImports=function(a,b,c){var d,e;return e=this,d=[],this.fp.read([a.workingPath,a.name],function(f){var g,h,i,j,k,l,m,n,o;o=e.findPatterns;for(k=0,m=o.length;k<m;k++)j=o[k],d=d.concat(f.match(j));d=_.filter(d,function(a){return a});for(l=0,n=d.length;l<n;l++)h=d[l],g=h.match(/['\"].*['\"]/)[0].replace(/['\"]/g,""),i=_.find(b,function(a){return a.name===g}),a.imports.push(i);return c()})},a.prototype.findDependents=function(a,b){var c,d,e,f,g;c=function(b){return a.name===b.name},g=[];for(e=0,f=b.length;e<f;e++)d=b[e],g.push(_.any(d.imports,c)?a.dependents++:void 0);return g},a.prototype.combine=function(a,b){var c,d,e,f,g;return f=this,a.combined?b():(e=this.scheduler.pipeline,c=this.fp,a.imports.length>0?(g=function(){var b,c,e,g;e=a.imports,g=[];for(b=0,c=e.length;b<c;b++)d=e[b],g.push(f.getStep(d));return g}(),c.read([a.workingPath,a.name],function(d){return e(d,g,function(d){return c.write([a.workingPath,a.name],d,function(){return b()})})})):b())},a.prototype.getStep=function(a){var b;return b=this,function(c,d){return b.replace(c,a,d)}},a.prototype.replace=function(a,b,c){var d,e,f,g;return d=this.replacePatterns,e=this.scheduler.pipeline,f=b.name,g=b.workingPath,this.fp.read([g,f],function(b){var g,h;return h=function(){var a,c,e;e=[];for(a=0,c=d.length;a<c;a++)g=d[a],e.push(function(a,c){var d,e;return e=g.toString().replace(/replace/,f),e=e.substring(1,e.length-2),d=new RegExp(e,"g"),c(a.replace(d,b))});return e}(),e(a,h,function(a){return c(a)})})},a}(),exports.combiner=Combiner,jsp=require("uglify-js").parser,pro=require("uglify-js").uglify,jslint=require("readyjslint").JSLINT,gzipper=require("gzip"),cssminifier=require("cssmin"),StylePipeline=function(){function a(a,b,c,d,e){this.config=a,this.fp=b,this.minifier=c,this.scheduler=d,this.log=e,_.bindAll(this)}return a.prototype.process=function(a,b){var c,d;return d=this,c=this.scheduler.parallel,c(a,this.wrap,function(){var e;return e=[],d.config.cssmin&&(e=_.map(a,function(a){return _.clone(a)})),c(a,d.finalize,function(){return c(e,d.minify,function(){return c(e,d.finalize,function(){return b(a.concat(e))})})})})},a.prototype.minify=function(a,b){var c,d;return this.config.cssmin?(d=this,ext=a.ext(),c=a.name.replace(ext,".min.css"),d.fp.transform([a.workingPath,a.name],function(a,b){return b(d.minifier.cssmin(a))},[a.workingPath,c],function(){return a.name=c,b()})):b()},a.prototype.finalize=function(a,b){var c,d,e;return e=this,this.config.finalize&&this.config.finalize.style?(d=this.config.finalize.style.header,c=this.config.finalize.style.footer,this.fp.transform([a.workingPath,a.name],function(a,b){return d&&(a=d+a),c&&(a+=c),b(a)},[a.workingPath,a.name],b)):b()},a.prototype.wrap=function(a,b){var c,d,e;return d=this,this.config.wrap&&this.config.wrap.style?(c=this.config.wrap.style.prefix,e=this.config.wrap.style.suffix,this.fp.transform([a.workingPath,a.name],function(a,b){return c&&(a=c+a),e&&(a+=e),b(a)},[a.workingPath,a.name],b)):b()},a}(),SourcePipeline=function(){function a(a,b,c,d,e){this.config=a,this.fp=b,this.minifier=c,this.scheduler=d,this.log=e,_.bindAll(this)}return a.prototype.process=function(a,b){var c,d;return d=this,c=this.scheduler.parallel,c(a,this.wrap,function(){var e;return e=[],d.config.uglify&&(e=_.map(a,function(a){return _.clone(a)})),c(a,d.finalize,function(){return c(e,d.minify,function(){return c(e,d.finalize,function(){return b(a.concat(e))})})})})},a.prototype.minify=function(a,b){var c,d;return this.config.uglify?(d=this,ext=a.ext(),c=a.name.replace(ext,".min.js"),this.log.onStep("Uglifying "+c),this.fp.transform([a.workingPath,a.name],function(b,c){return d.minifier(b,function(e,f){return e&&(d.log.onError("Error minifying "+a.name+" : \r\n	 "+e),f=b),c(f)})},[a.workingPath,c],function(){return a.name=c,b()})):b()},a.prototype.finalize=function(a,b){var c,d,e;return e=this,this.config.finalize&&this.config.finalize.source?(this.log.onStep("Finalizing "+a.name),d=this.config.finalize.source.header,c=this.config.finalize.source.footer,this.fp.transform([a.workingPath,a.name],function(a,b){return d&&(a=d+a),c&&(a+=c),b(a)},[a.workingPath,a.name],function(){return b()})):b()},a.prototype.wrap=function(a,b){var c,d,e;return d=this,this.config.wrap&&this.config.wrap.source?(c=this.config.wrap.source.prefix,e=this.config.wrap.source.suffix,this.fp.transform([a.workingPath,a.name],function(a,b){return c&&(a=c+a),e&&(a+=e),b(a)},[a.workingPath,a.name],b)):b()},a}(),MarkupPipeline=function(){function a(){}return a}(),PostProcessor=function(){function a(a,b,c,d){var e;this.config=a,this.fp=b,this.scheduler=c,this.log=d,e=function(a,b){var c;try{return c=jsp.parse(a),c=pro.ast_mangle(c),c=pro.ast_squeeze(c),b(void 0,pro.gen_code(c))}catch(d){return b(d,"")}},this.style=new StylePipeline(this.config,this.fp,cssminifier,this.scheduler,this.log),this.source=new SourcePipeline(this.config,this.fp,e,this.scheduler,this.log),this.markup={process:function(a,b){return b(a)}}}return a}(),exports.postProcessor=PostProcessor,Anvil=function(){function a(a,b,c,d,e,f,g,h){this.config=a,this.fp=b,this.compiler=c,this.combiner=d,this.scheduler=e,this.postProcessor=f,this.log=g,this.callback=h,a=this.config,this.filesBuilt={},this.inProcess=!1,this.steps={source:!1,style:!1,markup:!1,hasSource:a.source,hasStyle:a.style,hasMarkup:a.markup,markupReady:function(){return(this.source||!this.hasSource)&&(this.style||!this.hasStyle)},allDone:function(){var a;return a=(this.source||!this.hasSource)&&(this.style||!this.hasStyle)&&(this.markup||!this.hasMarkup),a}}}return a.prototype.build=function(){if(!this.inProcess)return this.inProcess=!0,this.buildSource(),this.buildStyle()},a.prototype.buildMarkup=function(){var a,b;return a=[/[\<][!][-]{2}.?import[(]?.?['\"].*['\"].?[)]?.?[-]{2}[\>]/g],b=[/[\<][!][-]{2}.?import[(]?.?['\"]replace['\"].?[)]?.?[-]{2}[\>]/g],this.processType("markup",a,b)},a.prototype.buildSource=function(){var a,b;return a=[/([\/]{2}|[\#]{3}).?import.?[(]?.?[\"'].*[\"'].?[)]?[;]?.?([\/]{2}|[\#]{3})?/g],b=[/([\/]{2}|[\#]{3}).?import.?[(]?.?[\"']replace[\"'].?[)]?[;]?.?([\/]{2}|[\#]{3})?/g],this.processType("source",a,b)},a.prototype.buildStyle=function(){var a,b;return a=[/([\/]{2}|[\/][*]).?import[(]?.?[\"'].*[\"'].?[)]?([*][\/])?/g],b=[/([\/]{2}|[\/][*]).?import[(]?.?[\"']replace[\"'].?[)]?([*][\/])?/g],this.processType("style",a,b)},a.prototype.processType=function(a,b,c){var d,e,f,g,h;return h=this,g=this.scheduler,e=this.compiler,d=new this.combiner(this.fp,g,b,c),f=this.postProcessor,h.prepFiles(a,function(b){return h.copyFiles(b,function(){return d.combineList(b,function(){var c;return c=_.filter(b,function(a){return a.dependents===0}),g.parallel(c,e.compile,function(b){return f[a].process(b,function(b){return h.finalOutput(b,function(){return h.stepComplete(a)})})})})})})},a.prototype.finalOutput=function(a,b){var c,d,e;return e=this.fp,d=this.scheduler.parallel,c=function(a,b){return d(a.outputPaths,function(b,c){return e.copy([a.workingPath,a.name],[b,a.name],c)},b)},d(a,c,b)},a.prototype.copyFiles=function(a,b){var c,d;return d=this.fp,c=function(a,b){return d.copy(a.fullPath,[a.workingPath,a.name],b)},this.scheduler.parallel(a,c,b)},a.prototype.cleanWorking=function(a){var b,c;return c=this.fp,b=this.scheduler.parallel,c.getFiles(this.config.working,function(d){return b(d,c["delete"],a)})},a.prototype.prepFiles=function(a,b){var c,d,e;return e=this.config.working,d=this.config[a],c=this.config.output[a],c=_.isArray(c)?c:[c],log=this.log,this.fp.getFiles(d,function(f){var g,h,i;return log.onEvent("Scanning "+f.length+" "+a+" files ..."),h=function(){var a,b,h;h=[];for(a=0,b=f.length;a<b;a++)g=f[a],i=path.basename(g),h.push({dependents:0,ext:function(){return path.extname(this.name)},fullPath:g,imports:[],name:i,originalName:i,outputPaths:c,relativePath:g.replace(d,""),workingPath:e});return h}(),b(h)})},a.prototype.stepComplete=function(a){this.steps[a]=!0,a!=="markup"&&this.steps.markupReady()&&this.buildMarkup();if(a==="markup"&&this.steps.allDone())return this.inProcess=!1,this.cleanWorking(this.callback)},a}(),Continuous=function(){function a(a,b,c){this.fp=a,this.config=b,this.onChange=c,this.style=this.normalize(this.config.style),this.source=this.normalize(this.config.source),this.markup=this.normalize(this.config.markup),this.spec=this.normalize(this.config.spec),this.watchers=[],this.watching=!1,_.bindAll(this),this}return a.prototype.normalize=function(a){return _.isArray(a)?a:[a]},a.prototype.setup=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;if(!this.watching){if(this.style){j=this.style;for(b=0,f=j.length;b<f;b++)a=j[b],this.watchPath(a)}if(this.source){k=this.source;for(c=0,g=k.length;c<g;c++)a=k[c],this.watchPath(a)}if(this.markup){l=this.markup;for(d=0,h=l.length;d<h;d++)a=l[d],this.watchPath(a)}if(this.spec){m=this.spec;for(e=0,i=m.length;e<i;e++)a=m[e],this.watchPath(a)}}return this.watching=!0},a.prototype.watchPath=function(a){return this.fp.getFiles(a,this.watchFiles)},a.prototype.watchFiles=function(a){var b,c,d,e;e=[];for(c=0,d=a.length;c<d;c++)b=a[c],e.push(this.watchers.push(fs.watch(b,this.onEvent)));return e},a.prototype.onEvent=function(a,b){this.watching=!1;while(this.watchers.length>0)this.watchers.pop().close();return this.onChange()},a}(),mocha=require("mocha"),reporters=mocha.reporters,interfaces=mocha.interfaces,Context=mocha.Context,Runner=mocha.Runner,Suite=mocha.Suite,MochaRunner=function(){function a(a,b,c,d){this.fp=a,this.scheduler=b,this.config=c,this.onComplete=d}return a.prototype.run=function(){var a,b,c,d,e,f,g,h,i,j,k,l;g=this;if(this.config.spec)return d=this.scheduler.parallel,c=this.fp.getFiles,e=(l=this.config).mocha||(l.mocha={growl:!0,ignoreLeaks:!0,reporter:"spec",ui:"bdd",colors:!0}),f=e.reporter.toLowerCase().replace(/([a-z])/,function(a){return a.toUpperCase()}),k=e.ui.toLowerCase(),i=new Suite("",new Context),a=reporters.Base,b=reporters[f],j=interfaces[k](i),e.colors&&(a.useColors=!0),e.slow&&(a.slow=e.slow),e.timeout&&i.timeout(e.timeout),h=_.isString(this.config.spec)?[this.config.spec]:this.config.spec,d(h,this.fp.getFiles,function(a){var c,d,f,h,j,k;d=_.flatten(a);for(j=0,k=d.length;j<k;j++)c=d[j],delete require.cache[c],i.emit("pre-require",global,c),i.emit("require",require(c,c)),i.emit("post-require",global,c);return i.emit("run"),h=new Runner(i),f=new b(h),e.ignoreLeaks&&(h.ignoreLeaks=!0),h.run(function(){return g.onComplete()})})},a}(),SocketServer=function(){function a(a){_.bindAll(this),this.clients=[],this.io=require("socket.io").listen(a),this.io.set("log level",1),this.io.sockets.on("connection",this.addClient)}return a.prototype.addClient=function(a){return this.clients.push(a),a.on("end",this.removeClient),a.on("disconnect",this.removeClient),log.onEvent("client connected")},a.prototype.removeClient=function(a){var b;return b=this.clients.indexOf(a),this.clients.splice(i,1),log.onEvent("client connected")},a.prototype.refreshClients=function(){return log.onEvent("Refreshing hooked clients"),this.notifyClients("refresh")},a.prototype.notifyClients=function(a){var b,c,d,e,f;e=this.clients,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b.emit(a,{}));return f},a}(),express=require("express"),Host=function(){function a(a,b,c,d){var e,f,g,h,i,j;this.fp=a,this.scheduler=b,this.compiler=c,this.config=d,i=this,_.bindAll(this),this.app=express.createServer(),e=this.app,e.use(express.bodyParser()),e.use(e.router),f=this.config.hosts,f?_.each(f,function(a,b){return e.use(b,express.static(path.resolve(a)))}):(g=this.config.output,j="",this.config.markup?_.isString(g)?j=g:_.isArray(g)?j=g[0]:j=g.markup:_.isString(g)?j=g:_.isArray(g)?j=g[0]:j=g.source,e.use("/",express.static(path.resolve(j))),this.config.ext&&e.use("/ext",express.static(path.resolve(this.config.ext))),this.config.spec&&e.use("/spec",express.static(path.resolve(this.config.spec)))),e.get(/.*[.](coffee|kup|less|styl|md|markdown|haml)/,function(a,b){var c,d;return c=a.get("content-disposition","filename"),ext=path.extname(fileName),d=i.contentTypes[ext],b.header("Content-Type",d),i.fp.read("."+a.url,function(a){return i.compiler.compilers[ext](a,function(a){return b.send(a)})})}),h=this.config.port?this.config.port:3080,e.listen(h)}return a.prototype.contentTypes={".coffee":"application/javascript",".less":"text/css",".styl":"text/css",".md":"text/html",".markdown":"text/html",".haml":"text/html",".kup":"text/html"},a}(),exports.run=function(){var a,b,c,d,e,f,g,h,i,j,k;return j=new Scheduler,i=new ArgParser,e=new FSCrawler(j),g=new FSProvider(e,log),d=new Configuration(g,i,j,log),c=new Compiler(g,log),h=void 0,b=void 0,a={},k={},f=function(){},d.configure(function(d){var e,i;d.continuous&&(b=new Continuous(g,d,function(){return f()})),d.mocha&&(h=new MochaRunner(g,j,d,function(){return log.onComplete("tests complete")})),d.host&&(i=new Host(g,j,c,d),k=new SocketServer(i.app)),e=new PostProcessor(d,g,j,log),a=new Anvil(d,g,c,Combiner,j,e,log,function(){log.onComplete("build done"),h&&setTimeout(function(){return h.run()},200),b&&setTimeout(function(){return b.setup()},200);if(k.refreshClients)return setTimeout(function(){return k.refreshClients()},200)}),f=function(){return a.build()},a.build();if(b)return b.setup()})}