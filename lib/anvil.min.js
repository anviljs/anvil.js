var ArgParser,builder,coffeeScript,colors,dive,emitter,events,express,fs,gzipper,jslint,jsp,mkdir,path,pro,resource,_;events=require("events"),emitter=events.EventEmitter,_=require("underscore"),colors=require("colors"),fs=require("fs"),mkdir=require("mkdirp").mkdirp,path=require("path"),ArgParser=require("argparser"),express=require("express"),resource=require("express-resource"),builder=require("DOMBuilder"),dive=require("dive"),jsp=require("uglify-js").parser,pro=require("uglify-js").uglify,jslint=require("readyjslint").JSLINT,gzipper=require("gzip"),coffeeScript=require("coffee-script");var onComplete,onError,onEvent,onStep;onEvent=function(a){return console.log("   "+a)},onStep=function(a){return console.log((""+a).blue)},onComplete=function(a){return console.log((""+a).green)},onError=function(a){return console.log(("!!! Error: "+a+" !!!").red)};var buildPath,deleteFile,ensurePath,forAll,forFilesIn,readFile,readFileSync,removeIntermediates,transformFile,transformFileSync,writeFile,writeFileSync;forAll=function(a,b,c){var d,e,f,g,h,i,j;a||c([]),d=a.length,g=[],e=function(a){d=d-1,a&&g.push(a);if(d===0)return c(g)},j=[];for(h=0,i=a.length;h<i;h++)f=a[h],j.push(b(f,e));return j},forFilesIn=function(a,b,c){var d,e,f;return d=0,f=[],e=function(a){d=d-1,a&&f.push(a);if(d===0)return c(f)},fs.readdir(a,function(c,f){var g,h,i,j,k,l,m;if(c)return onError(""+c+" occurred trying to read the path "+path);f=_.select(f,function(a){var b;return b=path.extname(a),b===".coffee"||b===".js"}),i=function(){var b,c,d;d=[];for(b=0,c=f.length;b<c;b++)j=f[b],d.push({full:path.join(a,j),file:j});return d}(),f=function(){var a,b,c;c=[];for(a=0,b=i.length;a<b;a++)j=i[a],c.push({file:j.file,stat:fs.statSync(j.full)});return c}(),h=_.pluck(_.select(f,function(a){return a.stat.isFile()}),"file"),d=h.length,m=[];for(k=0,l=h.length;k<l;k++)g=h[k],m.push(b(a,g,e));return m})},ensurePath=function(a,b){return path.exists(a,function(c){return c?b():mkdir(a,"0755",function(c){return c?onError("Could not create "+a+". "+c):b()})})},deleteFile=function(a,b,c){return fs.unlink(path.join(a,b),function(a){if(!a)return c(null)})},removeIntermediates=function(a){var b,c,d,e,f;forFilesIn(config.tmp,deleteFile,function(){return fs.rmdir(config.tmp)}),b=_.pluck(_.select(a,function(a){return a.used>0}),"file"),c=_.select(a,function(a){return a.used===0});for(e=0,f=b.length;e<f;e++)d=b[e],fs.unlink(d);return c},buildPath=function(a){var b,c;return b=a,_(a).isArray()&&(c=path.join,b=c.apply(this,a)),b},transformFile=function(a,b,c,d){return readFile(a,function(a){return b(a,function(a){return writeFile(c,a,d)})})},transformFileSync=function(a,b,c,d){return readFileSync(a,function(a){var e;return e=b(a),writeFileSync(c,e,d)})},readFile=function(a,b){var c;return c=buildPath(a),fs.readFile(c,"utf8",function(a,d){return a?onError("Error "+a+": reading "+c+"."):b(d)})},readFileSync=function(a,b){var c;c=buildPath(a);try{return b(fs.readFileSync(c,"utf8"))}catch(d){return onError("Error "+d+": reading "+c+".")}},writeFile=function(a,b,c){var d;return d=buildPath(a),fs.writeFile(d,b,"utf8",function(a){return a?onError("Error "+a+": writing "+d):c(d)})},writeFileSync=function(a,b,c){var d;d=buildPath(a);try{return fs.writeFileSync(d,b,"utf8"),c(d)}catch(e){return onError("Error "+e+": writing "+d+" (sync)")}};var config,configure,continuous,conventionConfig,ensurePaths,ext,importRegex,inProcess,loadConfig,loadConvention,prepConfig,test,writeConfig;config={},conventionConfig={source:"src",output:"lib",spec:"spec",ext:"ext",lint:{},uglify:{},gzip:{}},continuous=test=!1,inProcess=!1,ext={gzip:"gz",uglify:"min"},ensurePaths=function(a){return config.tmp=path.join(config.source,"tmp"),ensurePath(config.output,function(){return ensurePath(config.tmp,function(){return a()})})},configure=function(){var a,b,c,d,e,f;return e=new ArgParser,e.addValueOptions(["t","b","n"]),e.parse(),f=e.getOptions("n"),f&&(console.log("Creating scaffolding for "+f),ensurePath(f,function(){return ensurePath(f+"/src",function(){return ensurePath(f+"/lib",function(){return ensurePath(f+"/ext",function(){return ensurePath(f+"/spec",function(){return writeConfig(f+"/build.json")})})})})}),node.exit(0)),b=e.getOptions("b"),a=b?b:"build.json",c=e.getOptions("t","template"),c&&(d=c===!0?"build.json":c,writeConfig(d)),continuous=e.getOptions("ci"),test=e.getOptions("p","pavlov"),test&&startHost(),onStep("Checking for config..."),path.exists("./build.json",function(b){return prepConfig(b,a)})},prepConfig=function(a,b){return a?loadConfig(b):loadConvention()},loadConfig=function(a){return onStep("Loading config..."),readFile("./"+a,function(a){return config=JSON.parse(a),config.extensions&&(ext.gzip=config.extensions.gzip||ext.gzip,ext.uglify=config.extensions.uglify||ext.uglify),process()})},loadConvention=function(){return onStep("Loading convention..."),config=conventionConfig,process()},writeConfig=function(a){return writeFile(a,JSON.stringify(conventionConfig,null,"\t"),function(b){return onComplete(""+a+" created successfully!")})},importRegex=new RegExp('([/].|[#])import[( ]["].*["][ )][;]?([*/]{2})?',"g");var createStep,createTransformStep,gzip,lint,uglify,wrap;createStep=function(a,b){return function(c,d){return config[a]?(onStep("Step - "+a+": "+c),readFile(c,function(a){return b(c,a,d)})):d(c)}},createTransformStep=function(a,b,c){return function(d,e){var f;return config[a]?(onStep("Step - "+a+": "+d),f=c(d),transformFile(d,b,f,function(b){return onComplete("Step - "+a+" successful for "+d),e(b)})):e(d)}},lint=createStep("lint",function(a,b,c){var d,e,f,g,h;e=jslint(b,{});if(!e){onError("LINT FAILED ON "+a),d=_.select(jslint.errors,function(a){return a});for(g=0,h=d.length;g<h;g++)f=d[g],onEvent(("   line "+f.line+", pos "+f.character+" - "+f.reason).red)}else onComplete(""+a+" passed lint!");return c(a)}),uglify=createTransformStep("uglify",function(a,b){var c;return c=jsp.parse(a),c=pro.ast_mangle(c),c=pro.ast_squeeze(c),b(pro.gen_code(c))},function(a){return a.replace(".js","."+ext.uglify+".js")}),gzip=createTransformStep("gzip",function(a,b){return gzipper(a,function(a,c){return b(c)})},function(a){return a.replace(".js","."+ext.gzip+".js")}),wrap=createTransformStep("wrap",function(a,b){return config.wrap.prefix&&(a=config.wrap.prefix+"\r\n"+a),config.wrap.suffix&&(a=a+"\r\n"+config.wrap.suffix),b(a)},function(a){return a});var buildHead,buildScripts,createPage,startHost;createPage=function(){var a,b,c;return c=config.spec||(config.spec="./spec"),a=config.ext||(config.ext="./ext"),b=config.output||(config.output="./lib"),ensurePath(c,function(){return ensurePath(a,function(){var d,e,f,g,h,i;return i=fs.readdirSync(c),i=_.map(i,function(a){return path.join(c,a)}),d=fs.readdirSync(a),d=_.map(d,function(b){return path.join("..",a,b)}),f=fs.readdirSync(b),f=_.select(f,function(a){return!a.match(/[.]gz[.]/)}),f=_.map(f,function(a){return path.join("..",b,a)}),g=d.concat(f).concat(i),e=builder.html,h=e.HTML(buildHead(e,g),e.BODY(e.H1({id:"qunit-header"},e.H2({id:"qunit-banner"}),e.DIV({id:"qunit-testrunner-toolbar"}),e.H2({id:"qunit-userAgent"}),e.OL({id:"qunit-tests"})))),writeFileSync("index.html",h.toString(),function(){return onEvent("Pavlov test page generated")})})})},buildHead=function(a,b){var c,d,e,f,g;return d="pavlov",f=d+"/qunit.css",c=d+"/jquery-1.6.4.min.js",g=d+"/qunit.js",e=d+"/pavlov.js",a.HEAD(a.LINK({rel:"stylesheet",href:f,type:"text/css",media:"screen"}),a.SCRIPT({type:"text/javascript",src:c}),a.SCRIPT({type:"text/javascript",src:g}),a.SCRIPT({type:"text/javascript",src:e}),buildScripts(a,b))},buildScripts=function(a,b){return _.map(b,function(b){return a.SCRIPT({type:"text/javascript",src:b})})},startHost=function(){var a,b;return b=path.normalize(path.join(__dirname,"..","ext")),path.existsSync("./pavlov")||fs.symlinkSync(b,"./pavlov"),a=express.createServer(),a.use(express.bodyParser()),a.use("/",express.static(path.resolve("."))),a.listen(1580)};var buildTransforms,combine,compileCoffee,crawlFiles,createTransforms,findUses,pack,parseSource,precombineIncludes,process,rebuildList,transform;exports.run=function(){return configure()},process=function(){var a;if(!!a)return onError("There is already a build in process");a=!0;try{return ensurePaths(function(){return crawlFiles()})}catch(b){return a=!1,onError("The build failed failingly. Like a failure :@")}},crawlFiles=function(){var a;return forFilesIn(config.source,parseSource,function(a){var b;return onEvent(""+a.length+" files parsed."),b=function(b,c){return createTransforms(b,a,c)},forAll(a,b,transform)}),a=!1},transform=function(a){var b,c;return b=rebuildList(a),c=function(a,c){return combine(a,b,c)},forAll(b,c,pack)},pack=function(a){var b;return b=removeIntermediates(a),forAll(_.pluck(b,"file"),wrap,function(a){return forAll(a,lint,function(a){return forAll(a,uglify,function(a){return forAll(a,gzip,function(a){var b;onComplete("Output: "+a.toString()),b=!1,test&&createPage();if(continuous)return createWatch()})})})})},compileCoffee=function(a,b){var c,d;return d=b.replace(".coffee",".js"),c=path.join(a,b),transformFileSync(c,function(a){var b;try{return coffeeScript.compile(a,{bare:!0})}catch(c){return b=!1}},[config.tmp,d],function(a){return a===a}),d},parseSource=function(a,b,c){var d,e;d=path.join(a,b),onEvent("Parsing "+d);if(b.substr(b.length-6)!=="coffee"||!!config.justCoffee)return readFile(d,function(e){var f,g,h,i,j,k,l;h=e.match(importRegex),f=h!=null?h.length:void 0;if(h){g=function(){var a,b,c;c=[];for(a=0,b=h.length;a<b;a++)i=h[a],c.push(i.match(/[\"].*[\"]/)[0]);return c}(),g=function(){var a,b,c;c=[];for(a=0,b=g.length;a<b;a++)j=g[a],c.push(j.replace(/[\"]/g,""));return c}(),config.justCoffee||(g=function(){var a,b,c;c=[];for(a=0,b=g.length;a<b;a++)j=g[a],c.push(j.replace(".coffee",".js"));return c}());for(k=0,l=g.length;k<l;k++)j=g[k],onEvent("   - "+j);return c({fullPath:d,file:b,path:a,includes:g,combined:!1})}return c({fullPath:d,file:b,path:a,includes:[],combined:!1})});try{return b=compileCoffee(a,b),parseSource(config.tmp,b,c)}catch(f){return e=!1}},createTransforms=function(a,b,c){return a.includes.length===0&&c(a),forAll(a.includes,function(c,d){return buildTransforms(c,a,b,d)},function(b){return a.transforms=b,c(a)})},buildTransforms=function(a,b,c,d){var e,f,g,h,i;return f=a.replace(".coffee","").replace(".js","")+"[.](js|coffee)",i=new RegExp('([/].|[#]{1,3})import[( ]["]'+f+'["][ )]?[;]?([*/]{2})?[#]{0,3}',"g"),g=_.detect(c,function(b){return b.file===a}),h=config.source,g&&(h=config.output),e=path.join(h,a),onStep("Building transform for "+e),d(function(a){var b;return b=fs.readFileSync(e,"utf8"),a.replace(i,b)})},rebuildList=function(a){var b;return a=function(){var c,d,e;e=[];for(c=0,d=a.length;c<d;c++)b=a[c],e.push(findUses(b,a));return e}(),_.select(a,function(a){return a!==void 0})},findUses=function(a,b){var c,d;if(!a)return;return d=_.select(b,function(b){return _.any(b.includes,function(b){return a.file===b})}),c=d!=null?d.length:void 0,a.used=c||(c=0),a},combine=function(a,b,c){var d;return a.combined?a.combined:(onStep("Combining "+a.fullPath+" and its includes"),precombineIncludes(a.includes,b,c),d=path.join(config.output,a.file),transformFileSync(a.fullPath,function(b){var c,d,e,f;if(a.transforms){f=a.transforms;for(d=0,e=f.length;d<e;d++)c=f[d],b=c(b)}return b},d,function(b){return a.file=d,a.combined=!0,c(a)}))},precombineIncludes=function(a,b,c){var d,e,f,g,h;d=_.select(b,function(b){return _.any(a,function(a){return a===b.file&&!b.combined})}),h=[];for(f=0,g=d.length;f<g;f++)e=d[f],h.push(combine(e,b,c));return h};var createWatch,triggerProcess;createWatch=function(){var a,b;return a=!1,b=triggerProcess,dive(config.source,{recursive:!1,all:!1},function(a,c){if(!a)return fs.watchFile(c,{persistent:!0},function(a,d){var e;return onEvent("Change in "+c+" detected. Rebuilding..."),e=b,b=function(){},e()})})},triggerProcess=function(){return dive(config.source,{recursive:!1,all:!1},function(a,b){if(!a)return fs.unwatchFile(b)}),createPage(),process()}