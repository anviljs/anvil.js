<!DOCTYPE html>  <html> <head>   <title>anvil.html</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="stylesheets/docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               anvil.html             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Node's event emitter for all engines.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">events = </span><span class="nx">require</span><span class="p">(</span><span class="s">&quot;events&quot;</span><span class="p">)</span>
<span class="nv">emitter = </span><span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>JavaScript's functional programming helper library -- 
See http://documentcloud.github.com/underscore for more info</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;underscore&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Console colors for Node -- 
See https://github.com/Marak/colors.js for more info</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">colors = </span><span class="nx">require</span> <span class="s">&quot;colors&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Filesystem API</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fs = </span><span class="nx">require</span> <span class="s">&quot;fs&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Recursive mkdir for Node (think <em>mkdir -p</em>) -- 
See ://github.com/substack/node-mkdirp for more info</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">mkdir = </span><span class="nx">require</span><span class="p">(</span> <span class="s">&quot;mkdirp&quot;</span> <span class="p">).</span><span class="nx">mkdirp</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Node's path helper library</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">path = </span><span class="nx">require</span> <span class="s">&quot;path&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>A Sinatra inspired web development framework for Node -- 
See http://expressjs.com for more info</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">express = </span><span class="nx">require</span> <span class="s">&quot;express&quot;</span>
<span class="k">class</span> <span class="nx">Log</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h2>onEvent</h2>

<p>Logs events in default console color</p>

<h3>Args:</h3>

<ul>
<li><em>x {String}</em>: message to log</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onEvent: </span><span class="nf">(x) -&gt;</span>
    <span class="nx">unless</span> <span class="nx">quiet</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;   </span><span class="si">#{</span><span class="nx">x</span><span class="si">}</span><span class="s">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h2>onStep</h2>

<p>Logs steps in blue</p>

<h3>Args:</h3>

<ul>
<li><em>x {String}</em>: message to log</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onStep: </span><span class="nf">(x) -&gt;</span>
    <span class="nx">unless</span> <span class="nx">quiet</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">x</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">blue</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>onComplete</h2>

<p>Logs successful process completions in green</p>

<h3>Args:</h3>

<ul>
<li><em>x {String}</em>: message to log</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onComplete: </span><span class="nf">(x) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">x</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">green</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>onError</h2>

<p>Logs errors in red</p>

<h3>Args:</h3>

<ul>
<li><em>x {String}</em>: message to log</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onError: </span><span class="nf">(x) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;!!! </span><span class="si">#{</span><span class="nx">x</span><span class="si">}</span><span class="s"> !!!&quot;</span><span class="p">.</span><span class="nx">red</span>

<span class="nv">log = </span><span class="k">new</span> <span class="nx">Log</span><span class="p">()</span>

<span class="nv">exports.log = </span><span class="nx">log</span>
<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;underscore&quot;</span>
<span class="nv">path = </span><span class="nx">require</span> <span class="s">&quot;path&quot;</span>
<span class="nv">Commander = </span><span class="nx">require</span><span class="p">(</span> <span class="s">&quot;Commander&quot;</span> <span class="p">).</span><span class="nx">Command</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Configuration container</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">config = </span><span class="p">{</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Configuration defaults</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">siteConfig =</span>
  <span class="s">&quot;source&quot;</span><span class="o">:</span> <span class="s">&quot;src&quot;</span>
  <span class="s">&quot;style&quot;</span><span class="o">:</span> <span class="s">&quot;style&quot;</span>
  <span class="s">&quot;markup&quot;</span><span class="o">:</span> <span class="s">&quot;markup&quot;</span>
  <span class="s">&quot;output&quot;</span><span class="o">:</span> 
    <span class="p">{</span>
      <span class="s">&quot;source&quot;</span><span class="o">:</span> <span class="p">[</span> <span class="s">&quot;lib&quot;</span><span class="p">,</span> <span class="s">&quot;site/js&quot;</span> <span class="p">],</span>
      <span class="s">&quot;style&quot;</span><span class="o">:</span> <span class="p">[</span> <span class="s">&quot;css&quot;</span><span class="p">,</span> <span class="s">&quot;site/css&quot;</span> <span class="p">],</span>
      <span class="s">&quot;markup&quot;</span><span class="o">:</span> <span class="s">&quot;site/&quot;</span>
    <span class="p">}</span>
  <span class="s">&quot;spec&quot;</span><span class="o">:</span> <span class="s">&quot;spec&quot;</span>
  <span class="s">&quot;ext&quot;</span><span class="o">:</span> <span class="s">&quot;ext&quot;</span>
  <span class="s">&quot;lint&quot;</span><span class="o">:</span> <span class="p">{}</span>
  <span class="s">&quot;uglify&quot;</span><span class="o">:</span> <span class="p">{}</span>
  <span class="s">&quot;cssmin&quot;</span><span class="o">:</span> <span class="p">{}</span>
  <span class="s">&quot;hosts&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;/&quot;</span><span class="o">:</span> <span class="s">&quot;site&quot;</span>
  <span class="p">}</span>

<span class="nv">libConfig = </span>
  <span class="s">&quot;source&quot;</span><span class="o">:</span> <span class="s">&quot;src&quot;</span>
  <span class="s">&quot;output&quot;</span><span class="o">:</span> <span class="s">&quot;lib&quot;</span>
  <span class="s">&quot;spec&quot;</span><span class="o">:</span> <span class="s">&quot;spec&quot;</span>
  <span class="s">&quot;ext&quot;</span><span class="o">:</span> <span class="s">&quot;ext&quot;</span>
  <span class="s">&quot;lint&quot;</span><span class="o">:</span> <span class="p">{}</span>
  <span class="s">&quot;uglify&quot;</span><span class="o">:</span> <span class="p">{}</span>
  <span class="s">&quot;hosts&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;/&quot;</span><span class="o">:</span> <span class="s">&quot;spec&quot;</span>
  <span class="p">}</span>

<span class="nv">defaultMocha =</span>
  <span class="nv">growl: </span><span class="kc">true</span>
  <span class="nv">ignoreLeaks: </span><span class="kc">true</span>
  <span class="nv">reporter: </span><span class="s">&quot;spec&quot;</span>
  <span class="nv">ui: </span><span class="s">&quot;bdd&quot;</span>
  <span class="nv">colors: </span><span class="kc">true</span>

<span class="nv">defaultDoc =</span>
  <span class="nv">generator: </span><span class="s">&quot;docco&quot;</span>
  <span class="nv">output: </span><span class="s">&quot;docs&quot;</span>

<span class="nv">continuous = test = inProcess = quiet = debug = </span><span class="kc">false</span>
<span class="nv">version = </span><span class="s">&quot;0.7.3&quot;</span>

<span class="nv">ext =</span>
  <span class="nv">gzip: </span><span class="s">&quot;gz&quot;</span>
  <span class="nv">uglify: </span><span class="s">&quot;min&quot;</span>
  <span class="nv">cssmin: </span><span class="s">&quot;min&quot;</span>

<span class="nv">extensionLookup = </span>
  <span class="s">&quot;.css&quot;</span><span class="o">:</span> <span class="s">&quot;style&quot;</span>
  <span class="s">&quot;.scss&quot;</span><span class="o">:</span> <span class="s">&quot;style&quot;</span>
  <span class="s">&quot;.sass&quot;</span><span class="o">:</span> <span class="s">&quot;style&quot;</span>
  <span class="s">&quot;.less&quot;</span><span class="o">:</span> <span class="s">&quot;style&quot;</span>
  <span class="s">&quot;.stylus&quot;</span><span class="o">:</span> <span class="s">&quot;style&quot;</span>
  <span class="s">&quot;.js&quot;</span><span class="o">:</span> <span class="s">&quot;source&quot;</span>
  <span class="s">&quot;.coffee&quot;</span><span class="o">:</span> <span class="s">&quot;source&quot;</span>
  <span class="s">&quot;.markdown&quot;</span><span class="o">:</span> <span class="s">&quot;markup&quot;</span>
  <span class="s">&quot;.md&quot;</span><span class="o">:</span> <span class="s">&quot;markup&quot;</span>
  <span class="s">&quot;.html&quot;</span><span class="o">:</span> <span class="s">&quot;markup&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h2>Configuration</h2>

<p>Do all the things!
Calling anvil from the command line runs this.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Configuration</span> 

  <span class="nv">constructor: </span><span class="nf">( @fp, @scheduler, @log ) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h2>configure</h2>

<p>this call will return a configuration object that will
inform the rest of the process
* <em>onConfig {Function}</em>: the callback to invoke with a configuration object</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">configure: </span><span class="nf">( argList, onConfig ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">command = </span><span class="k">new</span> <span class="nx">Commander</span><span class="p">()</span>
    <span class="nx">command</span>
      <span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="s">&quot;0.7.4&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span> <span class="s">&quot;-b, --build [build file]&quot;</span><span class="p">,</span> <span class="s">&quot;Use a custom build file&quot;</span><span class="p">,</span> <span class="s">&quot;./build.json&quot;</span> <span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span> <span class="s">&quot;--ci&quot;</span><span class="p">,</span> <span class="s">&quot;Run a continuous integration build&quot;</span> <span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span> <span class="s">&quot;--host&quot;</span><span class="p">,</span> <span class="s">&quot;Setup a static HTTP host&quot;</span> <span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span> <span class="s">&quot;--lib [project]&quot;</span><span class="p">,</span> <span class="s">&quot;Create a lib project at the folder [project]&quot;</span> <span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span> <span class="s">&quot;--libfile [file name]&quot;</span><span class="p">,</span> <span class="s">&quot;Create a new lib build file named [file name]&quot;</span> <span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span> <span class="s">&quot;--site [project]&quot;</span><span class="p">,</span> <span class="s">&quot;Create a site project at the folder [project]&quot;</span> <span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span> <span class="s">&quot;--sitefile [file name]&quot;</span><span class="p">,</span> <span class="s">&quot;Create a new site build file named [file name]&quot;</span> <span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span> <span class="s">&quot;--mocha&quot;</span><span class="p">,</span> <span class="s">&quot;Run specifications using Mocha&quot;</span> <span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span> <span class="s">&quot;--docco&quot;</span><span class="p">,</span> <span class="s">&quot;Create annotated source using docco&quot;</span> <span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span> <span class="s">&quot;--ape&quot;</span><span class="p">,</span> <span class="s">&quot;Create annotated source using ape&quot;</span> <span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span> <span class="s">&quot;-q, --quiet&quot;</span><span class="p">,</span> <span class="s">&quot;Only print completion and error messages&quot;</span> <span class="p">)</span>

    <span class="nx">command</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">argList</span> <span class="p">);</span>

    <span class="k">if</span> <span class="nx">command</span><span class="p">.</span><span class="nx">libfile</span> <span class="o">or</span> <span class="nx">command</span><span class="p">.</span><span class="nx">sitefile</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Generate all the directories and the config file</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">name = </span><span class="nx">command</span><span class="p">.</span><span class="nx">libfile</span> <span class="o">or=</span> <span class="nx">command</span><span class="p">.</span><span class="nx">sitefile</span>
      <span class="nv">type = </span><span class="k">if</span> <span class="nx">command</span><span class="p">.</span><span class="nx">sitefile</span> <span class="k">then</span> <span class="s">&#39;site&#39;</span> <span class="k">else</span> <span class="s">&#39;lib&#39;</span>
      <span class="nx">@writeConfig</span> <span class="nx">type</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">.json&quot;</span><span class="p">,</span> <span class="nf">() -&gt;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">onComplete</span> <span class="s">&quot;Created </span><span class="si">#{</span> <span class="nx">type</span> <span class="si">}</span><span class="s"> build file - </span><span class="si">#{</span> <span class="nx">name</span> <span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">onConfig</span> <span class="nx">config</span><span class="p">,</span> <span class="kc">true</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">command</span><span class="p">.</span><span class="nx">site</span> <span class="o">or</span> <span class="nx">command</span><span class="p">.</span><span class="nx">lib</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Generate all the directories and the config file</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">type = </span><span class="k">if</span> <span class="nx">command</span><span class="p">.</span><span class="nx">site</span> <span class="k">then</span> <span class="s">&#39;site&#39;</span> <span class="k">else</span> <span class="s">&#39;lib&#39;</span>
      <span class="nv">scaffold = </span><span class="nx">command</span><span class="p">.</span><span class="nx">site</span> <span class="o">or=</span> <span class="nx">command</span><span class="p">.</span><span class="nx">lib</span>
      <span class="nv">config = </span><span class="k">if</span> <span class="nx">type</span> <span class="o">==</span> <span class="s">&#39;site&#39;</span> <span class="k">then</span> <span class="nx">siteConfig</span> <span class="k">else</span> <span class="nx">libConfig</span>
      <span class="nx">@log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Creating scaffolding for new </span><span class="si">#{</span> <span class="nx">type</span> <span class="si">}</span><span class="s"> project&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Create all the directories</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">ensurePaths</span><span class="p">(</span> <span class="nf">() -&gt;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">writeConfig</span><span class="p">(</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">scaffold</span> <span class="o">+</span> <span class="s">&quot;/build.json&quot;</span><span class="p">,</span> <span class="nf">() -&gt;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">onComplete</span> <span class="s">&quot;Scaffold ( </span><span class="si">#{</span> <span class="nx">scaffold</span> <span class="si">}</span><span class="s"> ) created.&quot;</span>
          <span class="nx">onConfig</span> <span class="nx">config</span><span class="p">,</span> <span class="kc">true</span>
        <span class="p">)</span>
      <span class="p">,</span> <span class="nx">scaffold</span> <span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">buildFile = </span><span class="nx">command</span><span class="p">.</span><span class="nx">build</span>
      <span class="nx">@log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Checking for </span><span class="si">#{</span> <span class="nx">buildFile</span> <span class="si">}</span><span class="s">&quot;</span>
      <span class="nv">exists = </span><span class="nx">@fp</span><span class="p">.</span><span class="nx">pathExists</span> <span class="nx">buildFile</span>
      <span class="nx">@prepConfig</span> <span class="nx">exists</span><span class="p">,</span> <span class="nx">buildFile</span><span class="p">,</span> <span class="nf">() -&gt;</span>
        <span class="k">if</span> <span class="nx">command</span><span class="p">.</span><span class="nx">host</span>
          <span class="nv">config.host = </span><span class="kc">true</span>

        <span class="k">if</span> <span class="nx">command</span><span class="p">.</span><span class="nx">ci</span>
          <span class="nv">config.continuous = </span><span class="kc">true</span>

        <span class="k">if</span> <span class="nx">command</span><span class="p">.</span><span class="nx">mocha</span>
          <span class="nv">config.mocha = </span><span class="nx">defaultMocha</span>

        <span class="k">if</span> <span class="nx">command</span><span class="p">.</span><span class="nx">ape</span>
          <span class="nv">config.docs = </span><span class="nx">defaultDoc</span>
          <span class="nv">config.docs.generator = </span><span class="s">&quot;ape&quot;</span>

        <span class="k">if</span> <span class="nx">command</span><span class="p">.</span><span class="nx">docco</span>
          <span class="nv">config.docs = </span><span class="nx">defaultDoc</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Run transforms and generate output</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">self</span><span class="p">.</span><span class="nx">ensurePaths</span> <span class="nf">() -&gt;</span>
          <span class="nx">onConfig</span> <span class="nx">config</span>   </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h2>createLibBuild</h2>

<p>This creates a file containing the default lib build convention</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">createLibBuild: </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>build lib template?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">buildLibTemplate</span>
      <span class="nv">output = </span><span class="k">if</span> <span class="nx">buildLibTemplate</span> <span class="o">==</span> <span class="kc">true</span> <span class="k">then</span> <span class="s">&quot;build.json&quot;</span> <span class="k">else</span> <span class="nx">buildLibTemplate</span>
      <span class="nx">writeConfig</span> <span class="s">&quot;lib&quot;</span><span class="p">,</span> <span class="nx">output</span>
      <span class="nx">global</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="nx">config</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h2>createSiteBuild</h2>

<p>This creates a file containing the default site build convention</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">createSiteBuild: </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>build site template?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">buildSiteTemplate</span>
      <span class="nv">output = </span><span class="k">if</span> <span class="nx">buildSiteTemplate</span> <span class="o">==</span> <span class="kc">true</span> <span class="k">then</span> <span class="s">&quot;build.json&quot;</span> <span class="k">else</span> <span class="nx">buildSiteTemplate</span>
      <span class="nx">writeConfig</span> <span class="s">&quot;site&quot;</span><span class="p">,</span> <span class="nx">output</span>
      <span class="nx">global</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="nx">config</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h2>ensurePaths</h2>

<p>Make sure that all expected paths exist</p>

<h3>Args:</h3>

<ul>
<li><em>onComplete {Function}</em>: what to call when work is complete</li>
<li><em>prefix {String}</em>: the prefix to prepend to all paths</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ensurePaths: </span><span class="nf">( onComplete, prefix ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">prefix = </span><span class="nx">prefix</span> <span class="o">or=</span> <span class="s">&quot;&quot;</span>
    <span class="nv">config.working = </span><span class="nx">config</span><span class="p">.</span><span class="nx">working</span> <span class="o">||</span> <span class="s">&quot;./tmp&quot;</span>
    <span class="nv">fp = </span><span class="nx">@fp</span>
    <span class="nv">paths = </span><span class="p">[</span>
      <span class="nx">config</span><span class="p">[</span> <span class="s">&quot;source&quot;</span> <span class="p">]</span>
      <span class="nx">config</span><span class="p">[</span> <span class="s">&quot;style&quot;</span> <span class="p">]</span>
      <span class="nx">config</span><span class="p">[</span> <span class="s">&quot;markup&quot;</span> <span class="p">]</span>
      <span class="nx">config</span><span class="p">[</span> <span class="s">&quot;spec&quot;</span> <span class="p">]</span>
      <span class="nx">config</span><span class="p">[</span> <span class="s">&quot;ext&quot;</span> <span class="p">]</span>
      <span class="nx">config</span><span class="p">[</span> <span class="s">&quot;working&quot;</span> <span class="p">]</span>
    <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>if documenting</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">docs</span>
      <span class="nx">paths</span><span class="p">.</span><span class="nx">push</span> <span class="nx">config</span><span class="p">.</span><span class="nx">docs</span><span class="p">.</span><span class="nx">output</span>
    
    <span class="nv">outputList = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>if the output is an object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">config</span><span class="p">.</span><span class="nx">output</span>
      <span class="nv">outputList = </span><span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span> <span class="nx">config</span><span class="p">.</span><span class="nx">output</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>if output is a single path</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">outputList = </span><span class="p">[</span> <span class="nx">config</span><span class="p">.</span><span class="nx">output</span> <span class="p">]</span>
    <span class="nv">paths = </span><span class="nx">paths</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">outputList</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>if names</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">name = </span><span class="nx">config</span><span class="p">.</span><span class="nx">name</span>
    <span class="k">if</span> <span class="nx">name</span>
      <span class="k">for</span> <span class="nx">output</span> <span class="k">in</span> <span class="nx">outputList</span>
        <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">name</span>
          <span class="nv">nestedPath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span> <span class="nx">name</span>
          <span class="k">if</span> <span class="nx">nestedPath</span> 
            <span class="nx">paths</span><span class="p">.</span><span class="nx">push</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">nestedPath</span>
        <span class="k">else</span>
          <span class="nv">nestedPaths = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">(</span> <span class="nx">name</span> <span class="p">),</span> <span class="nf">( x ) -&gt;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span> <span class="nx">x</span> <span class="p">)</span>
          <span class="nv">paths = </span><span class="nx">paths</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">nestedPaths</span>

    <span class="nv">worker = </span><span class="nf">( p, done ) -&gt;</span> 
      <span class="k">try</span> 
        <span class="nx">fp</span><span class="p">.</span><span class="nx">ensurePath</span> <span class="p">[</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">p</span> <span class="p">],</span> <span class="nf">() -&gt;</span>
          <span class="nx">done</span><span class="p">()</span>
      <span class="k">catch</span> <span class="nx">err</span>
        <span class="nx">done</span><span class="p">()</span>

    <span class="nx">@log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Ensuring project directory structure&quot;</span>
    <span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span> <span class="nx">paths</span><span class="p">,</span> <span class="nx">worker</span><span class="p">,</span> <span class="nf">() -&gt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">copyPrereqs</span> <span class="nx">onComplete</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h2>prepConfig</h2>

<p>Fallback to default config, if specified config doesn't exist</p>

<h3>Args:</h3>

<ul>
<li><em>exists {Boolean}</em>: does the specified config file exist?</li>
<li><em>file {String}</em>: config file name</li>
<li><em>onComplete {Function}</em>: what to do after config is prepped</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">prepConfig: </span><span class="nf">( exists, file, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">onDone = </span><span class="nf">() -&gt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">normalizeConfig</span> <span class="nx">onComplete</span>    
    <span class="nx">unless</span> <span class="nx">exists</span>
      <span class="nx">@loadConvention</span><span class="p">(</span> <span class="nx">onDone</span> <span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@loadConfig</span><span class="p">(</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">onDone</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h2>loadConfig</h2>

<p>Setup full configuration using specified config file 
For example, anvil -b custom.json</p>

<h3>Args:</h3>

<ul>
<li><em>file {String}</em>: config file name</li>
<li><em>onComplete {Function}</em>: what to do after config is loaded</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">loadConfig: </span><span class="nf">( file, onComplete ) -&gt;</span>
    <span class="nx">@log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Loading config...&quot;</span>
    <span class="nv">fp = </span><span class="nx">@fp</span>
    <span class="nx">fp</span><span class="p">.</span><span class="nx">read</span> <span class="nx">file</span><span class="p">,</span> <span class="nf">( content ) -&gt;</span>
      <span class="nv">config = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">content</span> <span class="p">)</span>
      <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">extensions</span>
        <span class="nv">ext.gzip = </span><span class="nx">config</span><span class="p">.</span><span class="nx">extensions</span><span class="p">.</span><span class="nx">gzip</span> <span class="o">||</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">gzip</span>
        <span class="nv">ext.uglify = </span><span class="nx">config</span><span class="p">.</span><span class="nx">extensions</span><span class="p">.</span><span class="nx">uglify</span> <span class="o">||</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">uglify</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Carry on!</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h2>loadConvention</h2>

<p>Sets up default config if no config file is found</p>

<h3>Args:</h3>

<ul>
<li><em>onComplete {Function}</em>: what to do after config is setup</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">loadConvention: </span><span class="nf">( onComplete ) -&gt;</span>
    <span class="nv">isSite = </span><span class="nx">@fp</span><span class="p">.</span><span class="nx">pathExists</span> <span class="s">&quot;./site&quot;</span>
    <span class="nv">conventionConfig = </span><span class="k">if</span> <span class="nx">isSite</span> <span class="k">then</span> <span class="nx">siteConfig</span> <span class="k">else</span> <span class="nx">libConfig</span>
    <span class="nx">@log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;No build file found, using </span><span class="si">#{</span> <span class="k">if</span> <span class="nx">isSite</span> <span class="k">then</span> <span class="s">&#39;site&#39;</span> <span class="k">else</span> <span class="s">&#39;lib&#39;</span> <span class="si">}</span><span class="s"> conventions&quot;</span>
    <span class="nv">config = </span><span class="nx">conventionConfig</span>
    <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h2>normalizeConfig</h2>

<p>Tries to normalize differences in configuration formats
between options and site vs. lib configurations</p>

<h4>Args:</h4>

<ul>
<li><em>onComplete {Function}</em>: what to call when work is complete</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">normalizeConfig: </span><span class="nf">( onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">fp = </span><span class="nx">@fp</span>
    <span class="nv">config.output = </span><span class="nx">config</span><span class="p">.</span><span class="nx">output</span> <span class="o">||</span> <span class="s">&quot;lib&quot;</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">config</span><span class="p">.</span><span class="nx">output</span>
      <span class="nv">outputPath = </span><span class="nx">config</span><span class="p">.</span><span class="nx">output</span>
      <span class="nv">config.output =</span>
        <span class="nv">style: </span><span class="nx">outputPath</span>
        <span class="nv">source: </span><span class="nx">outputPath</span>
        <span class="nv">markup: </span><span class="nx">outputPath</span>

    <span class="nv">calls = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>finalization?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">finalize = </span><span class="nx">config</span><span class="p">.</span><span class="nx">finalize</span>
    <span class="k">if</span> <span class="nx">finalize</span> 
      <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span> <span class="nf">( done ) -&gt;</span> 
        <span class="nx">self</span><span class="p">.</span><span class="nx">getFinalization</span> <span class="nx">finalize</span><span class="p">,</span> <span class="nf">( result ) -&gt;</span> 
          <span class="nv">config.finalize = </span><span class="nx">result</span>
          <span class="nx">done</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>wrapping?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">wrap = </span><span class="nx">config</span><span class="p">.</span><span class="nx">wrap</span>
    <span class="k">if</span> <span class="nx">wrap</span>
      <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span> <span class="nf">( done ) -&gt;</span> 
        <span class="nx">self</span><span class="p">.</span><span class="nx">getWrap</span> <span class="nx">wrap</span><span class="p">,</span> <span class="nf">( result ) -&gt;</span> 
          <span class="nv">config.wrap = </span><span class="nx">result</span>
          <span class="nx">done</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">mocha</span>
      <span class="nv">config.mocha = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">defaultMocha</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">mocha</span>

    <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">docs</span>
      <span class="nv">config.docs = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">defaultDoc</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">docs</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>any calls?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span> <span class="nx">calls</span><span class="p">,</span> 
        <span class="nf">( call, done ) -&gt;</span> 
          <span class="nx">call</span><span class="p">(</span> <span class="nx">done</span> <span class="p">)</span>
        <span class="p">,</span> <span class="nf">() -&gt;</span> <span class="nx">onComplete</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <h2>getFinalization</h2>

<p>Build up a custom state machine to address how
finalization should happen for this project</p>

<h3>Args:</h3>

<ul>
<li><em>original {Object}</em>: the existing finalization block</li>
<li><em>onComplete {Function}</em>: what to call when work is complete</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getFinalization: </span><span class="nf">( original, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">finalization = </span><span class="p">{}</span>
    <span class="nv">result = </span><span class="p">{}</span>
    <span class="nv">aggregation = </span><span class="p">{}</span>
    <span class="nv">aggregate = </span><span class="nx">@scheduler</span><span class="p">.</span><span class="nx">aggregate</span>
    </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>if there's no finalization</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">original</span> <span class="o">or</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEqual</span> <span class="nx">original</span><span class="p">,</span> <span class="p">{}</span>
      <span class="nx">onComplete</span> <span class="nx">finalization</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>if there's only one section</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="nx">original</span><span class="p">.</span><span class="nx">header</span> <span class="o">or</span> 
        <span class="nx">original</span><span class="p">[</span><span class="s">&quot;header-file&quot;</span><span class="p">]</span> <span class="o">or</span> 
        <span class="nx">original</span><span class="p">.</span><span class="nx">footer</span> <span class="o">or</span> 
        <span class="nx">original</span><span class="p">[</span><span class="s">&quot;footer-file&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>build out aggregation for resolving header and footer</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@getContentBlock</span> <span class="nx">original</span><span class="p">,</span> <span class="s">&quot;header&quot;</span><span class="p">,</span> <span class="nx">aggregation</span>
      <span class="nx">@getContentBlock</span> <span class="nx">original</span><span class="p">,</span> <span class="s">&quot;footer&quot;</span><span class="p">,</span> <span class="nx">aggregation</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>make sure we don't try to aggregate on empty</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEqual</span> <span class="nx">aggregation</span><span class="p">,</span> <span class="p">{}</span>
        <span class="nx">onComplete</span> <span class="nx">finalization</span>
      <span class="k">else</span>
        <span class="nx">aggregate</span> <span class="nx">aggregation</span><span class="p">,</span> <span class="nf">( constructed ) -&gt;</span>
          <span class="nv">finalization.source = </span><span class="nx">constructed</span>
          <span class="nx">onComplete</span> <span class="nx">finalization</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>there are multiple sections</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="nv">sources = </span><span class="p">{}</span>
      <span class="nv">blocks = </span><span class="p">{</span> 
        <span class="s">&quot;source&quot;</span><span class="o">:</span> <span class="nx">original</span><span class="p">[</span> <span class="s">&quot;source&quot;</span> <span class="p">],</span> 
        <span class="s">&quot;style&quot;</span><span class="o">:</span> <span class="nx">original</span><span class="p">[</span> <span class="s">&quot;style&quot;</span> <span class="p">],</span> 
        <span class="s">&quot;markup&quot;</span><span class="o">:</span> <span class="nx">original</span><span class="p">[</span> <span class="s">&quot;markup&quot;</span> <span class="p">]</span> 
      <span class="p">}</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">blocks</span><span class="p">,</span> <span class="nf">( block, name ) -&gt;</span> 
        <span class="nv">subAggregate = </span><span class="p">{}</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">getContentBlock</span> <span class="nx">block</span><span class="p">,</span> <span class="s">&quot;header&quot;</span><span class="p">,</span> <span class="nx">subAggregate</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">getContentBlock</span> <span class="nx">block</span><span class="p">,</span> <span class="s">&quot;footer&quot;</span><span class="p">,</span> <span class="nx">subAggregate</span>
        <span class="nx">sources</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nf">( done ) -&gt;</span> 
          <span class="nx">aggregate</span> <span class="nx">subAggregate</span><span class="p">,</span> <span class="nx">done</span>
      <span class="p">)</span>
      <span class="nx">aggregate</span> <span class="nx">sources</span><span class="p">,</span> <span class="nx">onComplete</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <h2>getWrap</h2>

<p>Build up a custom state machine to address how
wrapping should happen for this project</p>

<h3>Args:</h3>

<ul>
<li><em>original {Object}</em>: the existing wrap block</li>
<li><em>onComplete {Function}</em>: what to call when work is complete</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getWrap: </span><span class="nf">( original, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">wrap = </span><span class="p">{}</span>
    <span class="nv">result = </span><span class="p">{}</span>
    <span class="nv">aggregation = </span><span class="p">{}</span>
    <span class="nv">aggregate = </span><span class="nx">@scheduler</span><span class="p">.</span><span class="nx">aggregate</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>if there's no wrap</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">original</span> <span class="o">or</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEqual</span> <span class="nx">original</span><span class="p">,</span> <span class="p">{}</span>
      <span class="nx">onComplete</span> <span class="nx">wrap</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>if there's only one section</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="nx">original</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">or</span> 
        <span class="nx">original</span><span class="p">[</span><span class="s">&quot;prefix-file&quot;</span><span class="p">]</span> <span class="o">or</span> 
        <span class="nx">original</span><span class="p">.</span><span class="nx">suffix</span> <span class="o">or</span> 
        <span class="nx">original</span><span class="p">[</span><span class="s">&quot;suffix-file&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>build out aggregation for resolving prefix and suffix</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@getContentBlock</span> <span class="nx">original</span><span class="p">,</span> <span class="s">&quot;prefix&quot;</span><span class="p">,</span> <span class="nx">aggregation</span>
      <span class="nx">@getContentBlock</span> <span class="nx">original</span><span class="p">,</span> <span class="s">&quot;suffix&quot;</span><span class="p">,</span> <span class="nx">aggregation</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>make sure we don't try to aggregate on empty</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEqual</span> <span class="nx">aggregation</span><span class="p">,</span> <span class="p">{}</span>
        <span class="nx">onComplete</span> <span class="nx">wrap</span>
      <span class="k">else</span>
        <span class="nx">aggregate</span> <span class="nx">aggregation</span><span class="p">,</span> <span class="nf">( constructed ) -&gt;</span>
          <span class="nv">wrap.source = </span><span class="nx">constructed</span>
          <span class="nx">onComplete</span> <span class="nx">wrap</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>there are multiple sections</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="nv">sources = </span><span class="p">{}</span>
      <span class="nv">blocks = </span><span class="p">{</span> 
        <span class="s">&quot;source&quot;</span><span class="o">:</span> <span class="nx">original</span><span class="p">[</span> <span class="s">&quot;source&quot;</span> <span class="p">],</span> 
        <span class="s">&quot;style&quot;</span><span class="o">:</span> <span class="nx">original</span><span class="p">[</span> <span class="s">&quot;style&quot;</span> <span class="p">],</span> 
        <span class="s">&quot;markup&quot;</span><span class="o">:</span> <span class="nx">original</span><span class="p">[</span> <span class="s">&quot;markup&quot;</span> <span class="p">]</span> 
      <span class="p">}</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">blocks</span><span class="p">,</span> <span class="nf">( block, name ) -&gt;</span> 
        <span class="nv">subAggregate = </span><span class="p">{}</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">getContentBlock</span> <span class="nx">block</span><span class="p">,</span> <span class="s">&quot;prefix&quot;</span><span class="p">,</span> <span class="nx">subAggregate</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">getContentBlock</span> <span class="nx">block</span><span class="p">,</span> <span class="s">&quot;suffix&quot;</span><span class="p">,</span> <span class="nx">subAggregate</span>
        <span class="nx">sources</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nf">( done ) -&gt;</span> <span class="nx">aggregate</span> <span class="nx">subAggregate</span><span class="p">,</span> <span class="nx">done</span>
      <span class="p">)</span>
      <span class="nx">aggregate</span> <span class="nx">sources</span><span class="p">,</span> <span class="nx">onComplete</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <h2>getContentBlock</h2>

<p>Normalizes a wrapper or finalizer segment</p>

<h3>Args:</h3>

<ul>
<li>_property {string}: the property name to check for</li>
<li><em>source {Object}</em>: the configuration block</li>
<li><em>onComplete {Function}</em>: what to call when work is complete</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getContentBlock: </span><span class="nf">( source, property, aggregation ) -&gt;</span>
    <span class="nx">aggregation</span><span class="p">[</span> <span class="nx">property</span> <span class="p">]</span> <span class="o">=</span> <span class="nf">( done ) -&gt;</span> <span class="nx">done</span> <span class="s">&quot;&quot;</span>
    <span class="nv">fp = </span><span class="nx">@fp</span>
    <span class="k">if</span> <span class="nx">source</span>
      <span class="nv">propertyPath = </span><span class="nx">source</span><span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span> <span class="nx">property</span> <span class="si">}</span><span class="s">-file&quot;</span><span class="p">]</span>
      <span class="nv">propertyValue = </span><span class="nx">source</span><span class="p">[</span> <span class="nx">property</span> <span class="p">]</span>
      <span class="k">if</span> <span class="nx">propertyPath</span> <span class="o">and</span> <span class="nx">@fp</span><span class="p">.</span><span class="nx">pathExists</span> <span class="nx">propertyPath</span>
        <span class="nx">aggregation</span><span class="p">[</span> <span class="nx">property</span> <span class="p">]</span> <span class="o">=</span> <span class="nf">( done ) -&gt;</span> 
          <span class="nx">fp</span><span class="p">.</span><span class="nx">read</span> <span class="nx">propertyPath</span><span class="p">,</span> <span class="nf">( content ) -&gt;</span>
            <span class="nx">done</span> <span class="nx">content</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">propertyValue</span>
        <span class="nx">aggregation</span><span class="p">[</span> <span class="nx">property</span> <span class="p">]</span> <span class="o">=</span> <span class="nf">( done ) -&gt;</span> <span class="nx">done</span> <span class="nx">propertyValue</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <h2>copyPrereqs</h2>

<p>Copy the prerequisites for QUnit, pavlov and anvilHook.js
to the project's ext folder</p>

<h3>Args:</h3>

<ul>
<li><em>onComplete {Function}</em>: what to call when work is complete</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">copyPrereqs: </span><span class="nf">( onComplete ) -&gt;</span>
    <span class="nv">fp = </span><span class="nx">@fp</span>
    <span class="nv">forAll = </span><span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span>
    <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ext</span>
      <span class="nv">prereqPath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="s">&#39;../ext&#39;</span>
      <span class="nx">fp</span><span class="p">.</span><span class="nx">getFiles</span> <span class="nx">prereqPath</span><span class="p">,</span> <span class="nf">( files ) -&gt;</span>
        <span class="nv">copy = </span><span class="nf">( file, done ) -&gt;</span>
          <span class="nv">fileName = </span><span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span> <span class="nx">file</span> <span class="p">)</span>
          <span class="k">if</span> <span class="o">not</span> <span class="nx">fp</span><span class="p">.</span><span class="nx">pathExists</span> <span class="p">[</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ext</span><span class="p">,</span> <span class="nx">fileName</span> <span class="p">]</span>
            <span class="nx">fp</span><span class="p">.</span><span class="nx">copy</span> <span class="nx">file</span><span class="p">,</span> <span class="p">[</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ext</span><span class="p">,</span> <span class="nx">fileName</span> <span class="p">],</span> <span class="nx">done</span>
          <span class="k">else</span>
            <span class="nx">done</span><span class="p">()</span>
        <span class="nx">forAll</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">copy</span><span class="p">,</span> <span class="nf">() -&gt;</span> 
          <span class="nx">onComplete</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <h2>writeConfig</h2>

<p>Creates new default config file</p>

<h3>Args:</h3>

<ul>
<li><em>name {String}</em>: the config file name</li>
<li><em>onComplete {Function}</em>: what to call when work is complete</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">writeConfig: </span><span class="nf">( type, name, onComplete ) -&gt;</span>
    <span class="nv">config = </span><span class="k">if</span> <span class="nx">type</span> <span class="o">==</span> <span class="s">&quot;lib&quot;</span> <span class="k">then</span> <span class="nx">libConfig</span> <span class="k">else</span> <span class="nx">siteConfig</span>
    <span class="nv">log = </span><span class="nx">@log</span>
    <span class="nv">json = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">config</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s">&quot;\t&quot;</span> <span class="p">)</span>
    <span class="nx">@fp</span><span class="p">.</span><span class="nx">write</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">json</span><span class="p">,</span> <span class="nf">() -&gt;</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">onComplete</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s"> created successfully!&quot;</span>
      <span class="nx">onComplete</span><span class="p">()</span>

<span class="nv">exports.configuration = </span><span class="nx">Configuration</span>

<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;underscore&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <h2>Scheduler</h2>

<p>Provides flow control abstractions
aggregate and parallel are essentially fork/join variations and
pipeline is an asynchronous way to pass an input through a series
of transforms.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Scheduler</span>

  <span class="nv">constructor: </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <h2>parallel</h2>

<p>This takes a list of items and a single asynchronous
function with the signature ( item, done ) and
calls the worker for each item only invoking onComplete
once all calls have completed.
* <em>items {Array}</em>: a list of items to process
* <em>worker {Function}</em>: the worker that processes all the items
* <em>onComplete {Function}</em>: the function to call once all workers have completed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">parallel: </span><span class="nf">( items, worker, onComplete ) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Fail fast if list is empty</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">items</span> <span class="o">or</span> <span class="nx">items</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nx">onComplete</span> <span class="p">[]</span>
    <span class="nv">count = </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">results = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Pushes <em>result</em> (if truthy) onto the <em>results</em> list and, if there are no more
items, calls <em>onComplete</em> with <em>results</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">done = </span><span class="nf">( result ) -&gt;</span>
      <span class="nv">count = </span><span class="nx">count</span> <span class="o">-</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Is <em>result</em> truthy?</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Append to <em>results</em>!</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span> <span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Is iteration complete?</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Call <em>onComplete</em>!</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">onComplete</span><span class="p">(</span> <span class="nx">results</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Iteration occurs here</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">worker</span><span class="p">(</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">done</span> <span class="p">)</span> <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <h2>pipeline</h2>

<p>This takes an item and mutates it by calling a series
of asynchronous workers with the signature ( item, done ) and
only invokes onComplete after the last function in the pipeline completes.
* <em>item {Object}</em>: the initial item to pass to the first call
* <em>workers {Array}</em>: the ordered list of functions that compose the pipeline
* <em>onComplete {Function}</em>: the function to call once the last function has completed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">pipeline: </span><span class="nf">( item, workers, onComplete ) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Fail fast if list is empty</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">item</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">workers</span> <span class="o">or</span> <span class="nx">workers</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nx">onComplete</span> <span class="nx">item</span> <span class="o">||</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>take the next worker in the list
and pass item (in its current state) to it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">iterate = </span><span class="nf">( done ) -&gt;</span>
      <span class="nv">worker = </span><span class="nx">workers</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
      <span class="nx">worker</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">done</span>
    <span class="nv">done = </span><span class="o">-&gt;</span>
    <span class="nv">done = </span><span class="nf">( product ) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>store the mutated product of the worker</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">item = </span><span class="nx">product</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Any workers remaining?</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">workers</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Call <em>onComplete</em>!</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">onComplete</span><span class="p">(</span> <span class="nx">product</span> <span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">iterate</span> <span class="nx">done</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>kick off the pipeline</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">iterate</span> <span class="nx">done</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <h2>aggregate</h2>

<p>Takes a hash map of calls and returns a corresponding hash map of
the results once all calls have completed. It's a weird fork/join
with named results vs. a randomly ordered list of results
* <em>calls {Object}</em>: the hash map of named asynchronous functions to call
* <em>onComplete {Function}</em>: the resulting hash map of corresponding values</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">aggregate: </span><span class="nf">( calls, onComplete ) -&gt;</span>
    <span class="nv">results = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>checks to see if all results have been collected</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">isDone = </span><span class="nf">() -&gt;</span> 
      <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span> <span class="nx">calls</span> <span class="p">).</span><span class="nx">keys</span><span class="p">().</span><span class="nx">all</span><span class="p">(</span> <span class="nf">( x ) -&gt;</span> <span class="nx">results</span><span class="p">[</span> <span class="nx">x</span> <span class="p">]</span> <span class="o">!=</span> <span class="kc">undefined</span> <span class="p">).</span><span class="nx">value</span><span class="p">()</span>
    </pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>build a callback for the specific named function</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">getCallback = </span><span class="nf">( name ) -&gt;</span>
      <span class="nf">( result ) -&gt;</span>
        <span class="nx">results</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>have all the other calls completed?</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">isDone</span><span class="p">()</span>
          <span class="nx">onComplete</span> <span class="nx">results</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>iterate through the call list and invoke each one</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">calls</span><span class="p">,</span> <span class="nf">( call, name ) -&gt;</span>
      <span class="nv">callback = </span><span class="nx">getCallback</span> <span class="nx">name</span>
      <span class="nx">call</span> <span class="nx">callback</span>
    <span class="p">)</span>

<span class="nv">exports.scheduler = </span><span class="nx">Scheduler</span>

<span class="nv">fs = </span><span class="nx">require</span> <span class="s">&quot;fs&quot;</span>
<span class="nv">path = </span><span class="nx">require</span> <span class="s">&quot;path&quot;</span>
<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;underscore&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <h2>FSCrawler</h2>

<p>Wrote a custom 'dive' replacement after
the API changed significantly. The needs of Anvil are
pretty unique - always crawl the whole directory structure
from the start point and don't start work until we know all the files.
This 'crawls' a directory and returns all the files in the
structure recursive.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">FSCrawler</span>

  <span class="nv">constructor: </span><span class="nf">( @scheduler ) -&gt;</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <h2>crawl</h2>

<p>Crawls the whole directory structure starting with <em>directory</em>
and returns the full file listing.
* <em>directory {String/Array}</em>: a string or path spec for the directory to start crawling at
* <em>onComplete {Function}</em>: the function to call with a complete list of all the files</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">crawl: </span><span class="nf">( directory, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">fileList = </span><span class="p">[]</span>
    <span class="nv">forAll = </span><span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span>
    <span class="k">if</span> <span class="nx">directory</span> <span class="o">and</span> <span class="nx">directory</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>get the fully qualified path</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">directory = </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">directory</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>read directory contents</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span> <span class="nx">directory</span><span class="p">,</span> <span class="nf">( err, contents ) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>if we didn't get an error and we have contents</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="o">not</span> <span class="nx">err</span> <span class="o">and</span> <span class="nx">contents</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="nv">qualified = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>resolve and push qualified paths into the array</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">contents</span>
            <span class="nx">qualified</span><span class="p">.</span><span class="nx">push</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">directory</span><span class="p">,</span> <span class="nx">item</span>
          </pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>find out if we have a directory or a file handle for
all the results from fs.readdir</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">self</span><span class="p">.</span><span class="nx">classifyHandles</span> <span class="nx">qualified</span><span class="p">,</span> <span class="nf">( files, directories ) -&gt;</span>
            <span class="nv">fileList = </span><span class="nx">fileList</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">files</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>if we found any directories, continue crawling those</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">directories</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
              <span class="nx">forAll</span> <span class="nx">directories</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">crawl</span><span class="p">,</span> <span class="nf">( files ) -&gt;</span>
                <span class="nv">fileList = </span><span class="nx">fileList</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span> <span class="nx">files</span>
                <span class="nx">onComplete</span> <span class="nx">fileList</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>no more directories at this level, return the file list</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span>
              <span class="nx">onComplete</span> <span class="nx">fileList</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>there was a problem or no files, return the list, we're done here</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span>
          <span class="nx">onComplete</span> <span class="nx">fileList</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>no more to do, return the list</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="nx">onComplete</span> <span class="nx">fileList</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <h2>classifyHandles</h2>

<p>Provides a fork/join wrapper around getting the fs stat objects for the list
of paths.
* <em>list {Array}</em>: the list of paths to check
* <em>onComplete {Function}</em>: the function to call with the lists of files and directories</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">classifyHandles: </span><span class="nf">( list, onComplete ) -&gt;</span>
    <span class="k">if</span> <span class="nx">list</span> <span class="o">and</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">@classifyHandle</span><span class="p">,</span> <span class="nf">( classified ) -&gt;</span>
        <span class="nv">files = </span><span class="p">[]</span>
        <span class="nv">directories = </span><span class="p">[]</span>
        <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">classified</span>
          <span class="k">if</span> <span class="nx">item</span><span class="p">.</span><span class="nx">isDirectory</span> <span class="k">then</span> <span class="nx">directories</span><span class="p">.</span><span class="nx">push</span> <span class="nx">item</span><span class="p">.</span><span class="nx">file</span> <span class="k">else</span> <span class="nx">files</span><span class="p">.</span><span class="nx">push</span> <span class="nx">item</span><span class="p">.</span><span class="nx">file</span>
        <span class="nx">onComplete</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">directories</span>
    <span class="k">else</span>
      <span class="nx">onComplete</span> <span class="p">[],</span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <h2>classifyHandle</h2>

<p>Get the fs stat and determine if the path is to a file or a directory
* <em>file {String}</em>: the path to check
* <em>onComplete {Function}</em>: the function to call with the result of the check</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">classifyHandle: </span><span class="nf">( file, onComplete ) -&gt;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">file</span><span class="p">,</span> <span class="nf">( err, stat ) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">onComplete</span> <span class="p">{</span> <span class="nv">file: </span><span class="nx">file</span><span class="p">,</span> <span class="nv">err: </span><span class="nx">err</span> <span class="p">}</span>
      <span class="k">else</span>
        <span class="nx">onComplete</span> <span class="p">{</span> <span class="nv">file: </span><span class="nx">file</span><span class="p">,</span> <span class="nv">isDirectory: </span><span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">()</span> <span class="p">}</span>

<span class="nv">exports.crawler = </span><span class="nx">FSCrawler</span>
<span class="nv">fs = </span><span class="nx">require</span> <span class="s">&quot;fs&quot;</span>
<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;underscore&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <h2>FSProvider</h2>

<p>An abstraction around file interaction.
This is necessary to test any of Anvil's file level
interactions.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">FSProvider</span>
  
  <span class="nv">constructor: </span><span class="nf">( @crawler, @log ) -&gt;</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <h2>buildPath</h2>

<p>Given an array or string pathspec, return a string pathspec</p>

<h3>Args:</h3>

<ul>
<li><em>pathSpec {Array, String}</em>: pathspec of either an array of strings or a single string</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">buildPath: </span><span class="nf">( pathSpec ) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">pathSpec</span> 
      <span class="s">&quot;&quot;</span>
    <span class="k">else</span>
      <span class="nv">fullPath = </span><span class="nx">pathSpec</span>
      <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">pathSpec</span> <span class="p">)</span>
        <span class="nv">fullPath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">.</span><span class="nx">apply</span> <span class="p">{},</span> <span class="nx">pathSpec</span>
      <span class="nx">fullPath</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <h2>delete</h2>

<p>Deletes a file, given the file name (<em>file</em>) and its parent (<em>dir</em>)</p>

<h3>Args:</h3>

<ul>
<li><em>dir {String}</em>: pathspec of parent dir</li>
<li><em>filePath {String}</em>: file name or path spec array</li>
<li><em>onDeleted {Function}</em>: callback called if the file delete is successful</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">delete</span><span class="o">:</span> <span class="nf">( filePath, onDeleted ) -&gt;</span>
    <span class="nv">filePath = </span><span class="nx">@buildPath</span> <span class="nx">filePath</span>
    <span class="k">if</span> <span class="nx">@pathExists</span> <span class="nx">filePath</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nf">( err ) -&gt;</span>
        <span class="nx">onDeleted</span><span class="p">()</span>
      </pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <h2>ensurePath</h2>

<p>Makes sure <em>pathSpec</em> path exists before calling <em>onComplete</em> by
calling <em>mkdir pathSpec...</em> if <em>pathSpec</em> does not initially exist</p>

<h3>Args:</h3>

<ul>
<li><em>pathSpec {String}</em>: path string or array</li>
<li><em>onComplete {Function}</em>: called if path exists or is successfully created</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ensurePath: </span><span class="nf">( pathSpec, onComplete ) -&gt;</span>
    <span class="nv">pathSpec = </span><span class="nx">@buildPath</span> <span class="nx">pathSpec</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">pathSpec</span><span class="p">,</span> <span class="nf">( exists ) -&gt;</span>
      <span class="nx">unless</span> <span class="nx">exists</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>No <em>target</em> yet. Let's make it!</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">mkdir</span> <span class="nx">pathSpec</span><span class="p">,</span> <span class="s">&quot;0755&quot;</span><span class="p">,</span> <span class="nf">( err ) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Couldn't make the path. Report and abort!</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">onError</span> <span class="s">&quot;Could not create </span><span class="si">#{</span><span class="nx">pathSpec</span><span class="si">}</span><span class="s">. </span><span class="si">#{</span><span class="nx">err</span><span class="si">}</span><span class="s">&quot;</span>
          <span class="k">else</span>
            <span class="nx">onComplete</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <h2>getFiles</h2>

<p>Get all files in a specific path specification
* <em>filePath {String/Array}</em>: a string or array specifying the path to get files for
* <em>onFiles {Function}</em>: the function to call with the list of full file paths</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getFiles: </span><span class="nf">( filePath, onFiles ) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">filePath</span> 
      <span class="nx">onFiles</span> <span class="p">[]</span>
    <span class="k">else</span>
      <span class="nv">filePath = </span><span class="nx">@buildPath</span> <span class="nx">filePath</span>
      <span class="nv">files = </span><span class="p">[]</span>
      <span class="nx">@crawler</span><span class="p">.</span><span class="nx">crawl</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">onFiles</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <h2>copy ##</h2>

<p>Copy a file
* <em>from {String/Array}</em>: the path spec for the file to copy
* <em>to {String/Array}</em>: the path spec for the destination
* <em>onComplete {Function}</em>: the function to call when the copy has completed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">copy: </span><span class="nf">( from, to, onComplete ) -&gt;</span>
    <span class="nv">from = </span><span class="k">this</span><span class="p">.</span><span class="nx">buildPath</span> <span class="nx">from</span>
    <span class="nv">to = </span><span class="k">this</span><span class="p">.</span><span class="nx">buildPath</span> <span class="nx">to</span>
    <span class="nv">readStream = </span><span class="kc">undefined</span>
    <span class="nv">writeStream = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span> <span class="nx">to</span> <span class="p">)</span>
    <span class="p">(</span> <span class="nv">readStream = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span> <span class="nx">from</span> <span class="p">)</span> <span class="p">).</span><span class="nx">pipe</span><span class="p">(</span> <span class="nx">writeStream</span> <span class="p">)</span>
    <span class="nx">readStream</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;end&#39;</span><span class="p">,</span> <span class="nf">() -&gt;</span>
      <span class="k">if</span> <span class="nx">writeStream</span>
        <span class="nx">writeStream</span><span class="p">.</span><span class="nx">destroySoon</span><span class="p">()</span>
      <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <h2>pathExists</h2>

<p>Sychronously (GASP) check for the existence of a file or directory
* <em>pathSpec {String/Array}</em>: the string or path spec of the file or directory to check for</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">pathExists: </span><span class="nf">( pathSpec ) -&gt;</span>
    <span class="nv">pathSpec = </span><span class="k">this</span><span class="p">.</span><span class="nx">buildPath</span> <span class="nx">pathSpec</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">pathSpec</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <h2>read</h2>

<p>Reads a file from <em>filePath</em> and calls <em>onFile</em> callback with contents (Asynchronously)</p>

<h3>Args:</h3>

<ul>
<li><em>filePath {String}</em>: pathspec of file to read and pass contents from</li>
<li><em>onContent {Function}</em>: callback to pass file's contents to</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">read: </span><span class="nf">( filePath, onContent ) -&gt;</span>
    <span class="nv">filePath = </span><span class="nx">@buildPath</span> <span class="nx">filePath</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">filePath</span><span class="p">,</span> <span class="s">&quot;utf8&quot;</span><span class="p">,</span> <span class="nf">( err, content ) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">onError</span> <span class="s">&quot;Could not read </span><span class="si">#{</span> <span class="nx">filePath</span> <span class="si">}</span><span class="s"> : </span><span class="si">#{</span> <span class="nx">err</span> <span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">onContent</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">err</span>
      <span class="k">else</span>
        <span class="nx">onContent</span> <span class="nx">content</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <h2>readSync</h2>

<p>Reads a file from <em>filePath</em> ... synchronously ... SHAME! SHAAAAAAME! (ok, not really)
This function only exists for a specific use case in config, where there's literally
no advantage to reading files asynchronously but writing the code that way would
be a huge pain. Rationalization FTW</p>

<h3>Args:</h3>

<ul>
<li><em>filePath {String}</em>: pathspec of file to read and pass contents from</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readSync: </span><span class="nf">( filePath ) -&gt;</span>
    <span class="nv">filePath = </span><span class="nx">@buildPath</span> <span class="nx">filePath</span>
    <span class="k">try</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="nx">filePath</span><span class="p">,</span> <span class="s">&quot;utf8&quot;</span>
    <span class="k">catch</span> <span class="nx">err</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">onError</span> <span class="s">&quot;Could not read </span><span class="si">#{</span> <span class="nx">filePath</span> <span class="si">}</span><span class="s"> : </span><span class="si">#{</span> <span class="nx">err</span> <span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <h2>transformFile</h2>

<p>Given input file <em>filePath</em>, perform <em>transform</em> upon it then write the transformed content
to <em>outputPath</em> and call <em>onComplete</em>. (All operations performed asynchronously.)</p>

<h3>Args:</h3>

<ul>
<li><em>filePath {String}</em>: pathspec of file to transform</li>
<li><em>transform {Function}</em>: transform to perform on the file</li>
<li><em>outputPath {String}</em>: pathspec of output file</li>
<li><em>onComplete {Function}</em>: called when all operations are complete</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">transform: </span><span class="nf">( filePath, transform, outputPath, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">filePath = </span><span class="nx">@buildPath</span> <span class="nx">filePath</span>
    <span class="nv">outputPath = </span><span class="nx">@buildPath</span> <span class="nx">outputPath</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span>
      <span class="nx">filePath</span><span class="p">,</span>
      <span class="nf">( content ) -&gt;</span>
        <span class="nx">transform</span> <span class="nx">content</span><span class="p">,</span> <span class="nf">( newContent, error ) -&gt;</span>
          <span class="k">if</span> <span class="o">not</span> <span class="nx">error</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">write</span> <span class="nx">outputPath</span><span class="p">,</span> <span class="nx">newContent</span><span class="p">,</span> <span class="nx">onComplete</span>
          <span class="k">else</span>
            <span class="nx">onComplete</span> <span class="nx">error</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <h2>write</h2>

<p>Writes <em>content</em> to file at <em>filePath</em> calling <em>done</em> after writing is complete (Asynchronously)</p>

<h3>Args:</h3>

<ul>
<li><em>filePath {String}</em>: pathspec of file to write</li>
<li><em>content {String}</em>: content to write to the file</li>
<li><em>onComplete {Function}</em>: called when all operations are complete</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">write: </span><span class="nf">( filePath, content, onComplete ) -&gt;</span>
    <span class="nv">filePath = </span><span class="nx">@buildPath</span> <span class="nx">filePath</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="s">&quot;utf8&quot;</span><span class="p">,</span> <span class="nf">( err ) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">onError</span> <span class="s">&quot;Could not write </span><span class="si">#{</span> <span class="nx">filePath</span> <span class="si">}</span><span class="s"> : </span><span class="si">#{</span> <span class="nx">err</span> <span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">onComplete</span> <span class="nx">err</span>
      <span class="k">else</span>
        <span class="nx">onComplete</span><span class="p">()</span>

<span class="nv">exports.fsProvider = </span><span class="nx">FSProvider</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Unfancy JavaScript -- 
See http://coffeescript.org/ for more info</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">coffeeScript = </span><span class="nx">require</span> <span class="s">&quot;coffee-script&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>LESS Compiler --
See http://lesscss.org</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">less = </span><span class="nx">require</span><span class="p">(</span> <span class="s">&quot;less&quot;</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>STYLUS Compiler --
See http://learnboost.github.com/stylus/</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">stylus = </span><span class="nx">require</span><span class="p">(</span> <span class="s">&quot;stylus&quot;</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>HAML Compiler --
See http://haml-lang.com/</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">haml = </span><span class="nx">require</span><span class="p">(</span> <span class="s">&quot;haml&quot;</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Markdown Compiler --
See http://github.com/chjj/marked</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">marked = </span><span class="nx">require</span><span class="p">(</span> <span class="s">&quot;marked&quot;</span> <span class="p">)</span>
<span class="nx">marked</span><span class="p">.</span><span class="nx">setOptions</span> <span class="p">{</span> <span class="nv">sanitize: </span><span class="kc">false</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>HAML Compiler --
See http://haml-lang.com/</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">coffeeKup = </span><span class="nx">require</span><span class="p">(</span> <span class="s">&quot;coffeekup&quot;</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>underscore --
The most essential JS lib that ever was
See http://underscorejs.org/</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;underscore&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <h2>Compiler</h2>

<p>'Compiles' files based on the extension to produce
browser friendly resources: JS, CSS, HTML</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Compiler</span>

  <span class="nv">constructor: </span><span class="nf">(@fp, @log) -&gt;</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <h2>compile</h2>

<p>Compiles a file with the correct compiler</p>

<h3>Args:</h3>

<ul>
<li><em>file {Object}</em>: file metadata for the file to compile</li>
<li><em>onComplete {Function}</em>: function to invoke when done</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compile: </span><span class="nf">( file, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">ext = </span><span class="nx">file</span><span class="p">.</span><span class="nx">ext</span><span class="p">()</span>
    <span class="nv">newExt = </span><span class="nx">@extensionMap</span><span class="p">[</span> <span class="nx">ext</span> <span class="p">]</span>
    <span class="nv">newFile = </span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">ext</span><span class="p">,</span> <span class="nx">newExt</span>
    <span class="nv">log = </span><span class="nx">@log</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">onEvent</span> <span class="s">&quot;Compiling </span><span class="si">#{</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="si">}</span><span class="s"> to </span><span class="si">#{</span> <span class="nx">newFile</span> <span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">compiler = </span><span class="nx">@compilers</span><span class="p">[</span> <span class="nx">ext</span> <span class="p">]</span>
    <span class="k">if</span> <span class="nx">compiler</span>
      <span class="nx">@fp</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span> 
        <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span>
        <span class="nx">compiler</span><span class="p">,</span>
        <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">newFile</span> <span class="p">],</span>
        <span class="nf">( err ) -&gt;</span>
          <span class="nx">unless</span> <span class="nx">err</span>
            <span class="nv">file.name = </span><span class="nx">newFile</span>
            <span class="nx">onComplete</span> <span class="nx">file</span>
          <span class="k">else</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">onError</span> <span class="s">&quot;Error compiling </span><span class="si">#{</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="si">}</span><span class="s">: \r\n </span><span class="si">#{</span> <span class="nx">err</span> <span class="si">}</span><span class="s">&quot;</span>
            <span class="nx">onComplete</span> <span class="nx">err</span>
      <span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">onComplete</span> <span class="nx">file</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <h2>extensionMap</h2>

<p>Provides a map of original to resulting extension</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">extensionMap:</span>
    <span class="s">&quot;.coffee&quot;</span> <span class="o">:</span> <span class="s">&quot;.js&quot;</span>
    <span class="s">&quot;.kup&quot;</span><span class="o">:</span> <span class="s">&quot;.html&quot;</span>
    <span class="s">&quot;.less&quot;</span><span class="o">:</span> <span class="s">&quot;.css&quot;</span>
    <span class="s">&quot;.styl&quot;</span><span class="o">:</span> <span class="s">&quot;.css&quot;</span>
    <span class="s">&quot;.sass&quot;</span><span class="o">:</span> <span class="s">&quot;.css&quot;</span>
    <span class="s">&quot;.scss&quot;</span><span class="o">:</span> <span class="s">&quot;.css&quot;</span>
    <span class="s">&quot;.haml&quot;</span><span class="o">:</span> <span class="s">&quot;.html&quot;</span>
    <span class="s">&quot;.md&quot;</span><span class="o">:</span> <span class="s">&quot;.html&quot;</span>
    <span class="s">&quot;.markdown&quot;</span><span class="o">:</span> <span class="s">&quot;.html&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <h2>compilers</h2>

<p>A simple hash map of file extension to a function that
invokes the corresponding compiler</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compilers:</span>
    <span class="s">&quot;.coffee&quot;</span> <span class="o">:</span> <span class="nf">( content, onContent ) -&gt;</span>
      <span class="k">try</span>
        <span class="nv">js = </span><span class="nx">coffeeScript</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">content</span><span class="p">,</span> <span class="p">{</span> <span class="nv">bare: </span><span class="kc">true</span> <span class="p">}</span>
        <span class="nx">onContent</span> <span class="nx">js</span>
      <span class="k">catch</span> <span class="nx">error</span>
        <span class="nx">onContent</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">error</span>
    <span class="s">&quot;.less&quot;</span> <span class="o">:</span> <span class="nf">( content, onContent ) -&gt;</span>
      <span class="k">try</span>
        <span class="nx">less</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span> <span class="nx">content</span><span class="p">,</span> <span class="p">{},</span> <span class="nf">(e, css) -&gt;</span> <span class="nx">onContent</span><span class="p">(</span><span class="nx">css</span><span class="p">)</span> <span class="p">)</span>
      <span class="k">catch</span> <span class="nx">error</span>
        <span class="nx">onContent</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">error</span>
    <span class="s">&quot;.sass&quot;</span> <span class="o">:</span> <span class="nf">( content, onContent ) -&gt;</span>
      <span class="k">try</span>
        <span class="nx">onContent</span> <span class="nx">content</span>
      <span class="k">catch</span> <span class="nx">error</span>
        <span class="nx">onContent</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">error</span>
    <span class="s">&quot;.scss&quot;</span> <span class="o">:</span> <span class="nf">( content, onContent ) -&gt;</span>
      <span class="k">try</span>
        <span class="nx">onContent</span> <span class="nx">content</span>
      <span class="k">catch</span> <span class="nx">error</span>
        <span class="nx">onContent</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">error</span>
    <span class="s">&quot;.styl&quot;</span> <span class="o">:</span> <span class="nf">( content, onContent ) -&gt;</span>
      <span class="k">try</span>
        <span class="nx">stylus</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span> <span class="nx">content</span><span class="p">,</span> <span class="p">{},</span> <span class="nf">(e, css) -&gt;</span> <span class="nx">onContent</span><span class="p">(</span> <span class="nx">css</span><span class="p">,</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">)</span>
      <span class="k">catch</span> <span class="nx">error</span>
        <span class="nx">onContent</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">error</span>
    <span class="s">&quot;.haml&quot;</span> <span class="o">:</span> <span class="nf">( content, onContent ) -&gt;</span>
      <span class="k">try</span>
        <span class="nv">html = </span><span class="nx">haml</span><span class="p">.</span><span class="nx">render</span> <span class="nx">content</span>
        <span class="nx">onContent</span> <span class="nx">html</span>
      <span class="k">catch</span> <span class="nx">error</span>
        <span class="nx">onContent</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">error</span>
    <span class="s">&quot;.md&quot;</span> <span class="o">:</span> <span class="nf">( content, onContent ) -&gt;</span>
      <span class="k">try</span>
        <span class="nx">onContent</span><span class="p">(</span> <span class="nx">marked</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">content</span> <span class="p">)</span> <span class="p">)</span>
      <span class="k">catch</span> <span class="nx">error</span>
        <span class="nx">onContent</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">error</span>
    <span class="s">&quot;.markdown&quot;</span> <span class="o">:</span> <span class="nf">( content, onContent ) -&gt;</span>
      <span class="k">try</span>
        <span class="nx">onContent</span><span class="p">(</span> <span class="nx">marked</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">content</span> <span class="p">)</span> <span class="p">)</span>
      <span class="k">catch</span> <span class="nx">error</span>
        <span class="nx">onContent</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">error</span>
    <span class="s">&quot;.kup&quot;</span> <span class="o">:</span> <span class="nf">( content, onContent ) -&gt;</span>
      <span class="k">try</span>
        <span class="nx">html</span> <span class="o">=</span><span class="p">(</span> <span class="nx">coffeeKup</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">content</span><span class="p">,</span> <span class="p">{}</span> <span class="p">)()</span>
        <span class="nx">onContent</span> <span class="nx">html</span>
      <span class="k">catch</span> <span class="nx">error</span>
        <span class="nx">onContent</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">error</span>

<span class="nv">exports.compiler = </span><span class="nx">Compiler</span>

<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;underscore&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <h2>Combiner</h2>

<p>Combines imports with the files importing them</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Combiner</span>

  <span class="nv">constructor: </span><span class="nf">( @fp, @scheduler, @findPatterns, @replacePatterns ) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <h2>combineList</h2>

<p>combine all the files in the <em>list</em> and call onComplete when finished</p>

<h3>Args:</h3>

<ul>
<li><em>list {Array}</em>: collection of file metadata</li>
<li><em>onComplete {Function}</em>: callback to invoke on completion</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">combineList: </span><span class="nf">( list, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">forAll = </span><span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>for all files in the list
    find all the imports for every file
then find all the files that depend on each file
then combine all the files in the list</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">findImports = </span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="nf">( file, done ) -&gt;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">findImports</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">done</span>
      <span class="p">,</span> <span class="k">this</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>once the imports are known, we can determine how many
files import (or depend) a given file</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">findDependents = </span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="nf">( file, done ) -&gt;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">findDependents</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">done</span>
      <span class="p">,</span> <span class="k">this</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>replace all of file's import statements with
the imported files' contents</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">combineFile = </span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="nf">( file, done ) -&gt;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">combineFile</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">done</span>
      <span class="p">,</span> <span class="k">this</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>combine all the files</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">forAll</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">findImports</span><span class="p">,</span> <span class="nf">() -&gt;</span>
      <span class="k">for</span> <span class="nx">f1</span> <span class="k">in</span> <span class="nx">list</span>
        <span class="nx">findDependents</span> <span class="nx">f1</span><span class="p">,</span> <span class="nx">list</span>
      <span class="nx">forAll</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">combineFile</span><span class="p">,</span> <span class="nx">onComplete</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <h2>combineFile</h2>

<p>combine a specifc <em>file</em> after ensuring it's dependencies have been combined</p>

<h3>Args:</h3>

<ul>
<li><em>file {Object}</em>: the file metadata describing the file to combine</li>
<li><em>onComplete {Function}</em>: callback to invoke on completion</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">combineFile: </span><span class="nf">( file, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">forAll = </span><span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>if we've already combined this file, just call complete</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">combined</span>
      <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>otherwise, combine all the file's dependencies first, then combine the file</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="nv">combineFile = </span><span class="nf">( file, done ) -&gt;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">combineFile</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">done</span>

      <span class="nv">dependencies = </span><span class="nx">file</span><span class="p">.</span><span class="nx">imports</span>
      <span class="k">if</span> <span class="nx">dependencies</span> <span class="o">and</span> <span class="nx">dependencies</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nx">forAll</span> <span class="nx">dependencies</span><span class="p">,</span> <span class="nx">combineFile</span><span class="p">,</span> <span class="nf">() -&gt;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">combine</span> <span class="nx">file</span><span class="p">,</span> <span class="nf">() -&gt;</span>
            <span class="nv">file.combined = </span><span class="kc">true</span>
            <span class="nx">onComplete</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">combine</span> <span class="nx">file</span><span class="p">,</span> <span class="nf">() -&gt;</span>
          <span class="nv">file.combined = </span><span class="kc">true</span>
          <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <h2>fileImports</h2>

<p>search the <em>file</em> using regex patterns and store all referenced files</p>

<h3>Args:</h3>

<ul>
<li><em>file {Object}</em>: the file metadata describing the file to combine</li>
<li><em>list {Array}</em>: collection of file metadata</li>
<li><em>onComplete {Function}</em>: callback to invoke on completion</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">findImports: </span><span class="nf">( file, list, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">imports = </span><span class="p">[]</span>
    <span class="nx">@fp</span><span class="p">.</span><span class="nx">read</span> <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span> <span class="nf">( content ) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>find the import statements in the file contents using @findPatterns</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">pattern</span> <span class="k">in</span> <span class="nx">self</span><span class="p">.</span><span class="nx">findPatterns</span>
        <span class="nv">imports = </span><span class="nx">imports</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">content</span><span class="p">.</span><span class="nx">match</span> <span class="nx">pattern</span>
      <span class="nv">imports = </span><span class="nx">_</span><span class="p">.</span><span class="nx">filter</span> <span class="nx">imports</span><span class="p">,</span> <span class="nf">( x ) -&gt;</span> <span class="nx">x</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>strip out all the raw file names from the import statements
find the matching file metadata for the import</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">imported</span> <span class="k">in</span> <span class="nx">imports</span>
        <span class="nv">importName = </span><span class="p">(</span> <span class="nx">imported</span><span class="p">.</span><span class="nx">match</span> <span class="sr">///[&#39;\&quot;].*[&#39;\&quot;]///</span> <span class="p">)[</span> <span class="mi">0</span> <span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">///[&#39;\&quot;]///g</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">)</span>
        <span class="nv">importedFile = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">list</span><span class="p">,</span> <span class="nf">( i ) -&gt;</span> 
          <span class="nx">i</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">importName</span> <span class="p">)</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">imports</span><span class="p">.</span><span class="nx">push</span> <span class="nx">importedFile</span>
      <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <h2>fileDependents</h2>

<p>search the <em>list</em> to see if any files import <em>file</em></p>

<h3>Args:</h3>

<ul>
<li><em>file {Object}</em>: the file metadata describing the file to combine</li>
<li><em>list {Array}</em>: collection of file metadata</li>
<li><em>onComplete {Function}</em>: callback to invoke on completion</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">findDependents: </span><span class="nf">( file, list ) -&gt;</span>
    <span class="nv">imported = </span><span class="nf">( importFile ) -&gt;</span>
      <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">importFile</span><span class="p">.</span><span class="nx">name</span>
    <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">list</span>
      <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">any</span> <span class="nx">item</span><span class="p">.</span><span class="nx">imports</span><span class="p">,</span> <span class="nx">imported</span> <span class="k">then</span> <span class="nx">file</span><span class="p">.</span><span class="nx">dependents</span><span class="o">++</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <h2>combine</h2>

<p>combine all the <em>file</em>'s imports into its contents</p>

<h3>Args:</h3>

<ul>
<li><em>file {Object}</em>: the file metadata describing the file to combine</li>
<li><em>onComplete {Function}</em>: callback to invoke on completion</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">combine: </span><span class="nf">( file, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nx">unless</span> <span class="nx">file</span><span class="p">.</span><span class="nx">combined</span>
      <span class="nv">pipe = </span><span class="nx">@scheduler</span><span class="p">.</span><span class="nx">pipeline</span>
      <span class="nv">fp = </span><span class="nx">@fp</span>
      <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">imports</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>creates a closure around a specific import to prevent
access to a changing variable</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">steps = </span><span class="k">for</span> <span class="nx">imported</span> <span class="k">in</span> <span class="nx">file</span><span class="p">.</span><span class="nx">imports</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">getStep</span> <span class="nx">imported</span>
        <span class="nx">fp</span><span class="p">.</span><span class="nx">read</span> <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span> <span class="nf">( main ) -&gt;</span>
          <span class="nx">pipe</span> <span class="nx">main</span><span class="p">,</span> <span class="nx">steps</span><span class="p">,</span> <span class="nf">( result ) -&gt;</span>
            <span class="nx">fp</span><span class="p">.</span><span class="nx">write</span> <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span> <span class="nx">result</span><span class="p">,</span> <span class="nf">() -&gt;</span> <span class="nx">onComplete</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">onComplete</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <h2>getStep</h2>

<p>This is insane but it works - creating a closure around
a specific import to prevent accessing a changing variable.
* <em>import {String}</em>: the imported file to create the closure around</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getStep: </span><span class="nf">( imported ) -&gt;</span> 
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nf">( text, onDone ) -&gt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">imported</span><span class="p">,</span> <span class="nx">onDone</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <h2>replace</h2>

<p>create a replacement regex that will take the <em>imported</em> content and replace the
matched patterns within the main file's <em>content</em></p>

<h3>Args:</h3>

<ul>
<li><em>content {Object}</em>: the content of the main file</li>
<li><em>imported {Object}</em>: file metadata for the imported</li>
<li><em>onComplete {Function}</em>: callback to invoke on completion</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">replace: </span><span class="nf">( content, imported, onComplete ) -&gt;</span>
    <span class="nv">patterns = </span><span class="nx">@replacePatterns</span>
    <span class="nv">pipe = </span><span class="nx">@scheduler</span><span class="p">.</span><span class="nx">pipeline</span>
    <span class="nv">source = </span><span class="nx">imported</span><span class="p">.</span><span class="nx">name</span>
    <span class="nv">working = </span><span class="nx">imported</span><span class="p">.</span><span class="nx">workingPath</span>
    <span class="nx">@fp</span><span class="p">.</span><span class="nx">read</span> <span class="p">[</span> <span class="nx">working</span><span class="p">,</span> <span class="nx">source</span> <span class="p">],</span> <span class="nf">( newContent ) -&gt;</span>
      <span class="nv">steps = </span><span class="k">for</span> <span class="nx">pattern</span> <span class="k">in</span> <span class="nx">patterns</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>creates a function that will replace the import statement
with a specific file's contents</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nf">( current, done ) -&gt;</span>
          <span class="nv">stringified = </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">replace</span> <span class="sr">///replace///</span><span class="p">,</span> <span class="nx">source</span>
          <span class="nv">stringified = </span><span class="nx">stringified</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">stringified</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">)</span>
          <span class="nv">fullPattern = </span><span class="k">new</span> <span class="nb">RegExp</span> <span class="nx">stringified</span><span class="p">,</span> <span class="s">&quot;g&quot;</span>         
          <span class="nv">capture = </span><span class="nx">fullPattern</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span> <span class="nx">content</span> <span class="p">)</span>
          <span class="k">if</span> <span class="nx">capture</span> <span class="o">and</span> <span class="nx">capture</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>capture the indentation of the import</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">whiteSpace = </span><span class="nx">capture</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>apply indentation to all lines of the new content</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">newContent = </span><span class="s">&quot;</span><span class="si">#{</span> <span class="nx">whiteSpace</span> <span class="si">}</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nx">newContent</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">///\n///g</span><span class="p">,</span> <span class="s">&quot;\n</span><span class="si">#{</span> <span class="nx">whiteSpace</span> <span class="si">}</span><span class="s">&quot;</span>
          <span class="nx">done</span><span class="p">(</span> <span class="nx">current</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">fullPattern</span><span class="p">,</span> <span class="nx">newContent</span> <span class="p">)</span>
      <span class="nx">pipe</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">steps</span><span class="p">,</span> <span class="nf">( result ) -&gt;</span>
        <span class="nx">onComplete</span> <span class="nx">result</span>

<span class="nv">exports.combiner = </span><span class="nx">Combiner</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>Uglify: JavaScript parser and compressor/beautifier toolkit -- 
See https://github.com/mishoo/UglifyJS for more info</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">jsp = </span><span class="nx">require</span><span class="p">(</span> <span class="s">&quot;uglify-js&quot;</span> <span class="p">).</span><span class="nx">parser</span>
<span class="nv">pro = </span><span class="nx">require</span><span class="p">(</span> <span class="s">&quot;uglify-js&quot;</span> <span class="p">).</span><span class="nx">uglify</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>A Node-compatible port of Douglas Crockford's JSLint -- </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">jslint = </span><span class="nx">require</span><span class="p">(</span> <span class="s">&quot;readyjslint&quot;</span> <span class="p">).</span><span class="nx">JSLINT</span></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>CSS Minifier --
See https://github.com/jbleuzen/node-cssmin</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">cssminifier = </span><span class="nx">require</span> <span class="s">&quot;cssmin&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <h2>StylePipeline</h2>

<p>The set of post-processes that happen to completed style outputs.
These include minification, wrapping and
finalization depending on the build configuration.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">StylePipeline</span>

  <span class="nv">constructor: </span><span class="nf">( @config, @fp, @minifier, @scheduler, @log ) -&gt;</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <h2>process</h2>

<p>Take the list of files and minify, wrap and finalize them
according to configuration. In the event that files are minified,
this function will create a seperate set of files to separate
processing between developer friendly and deployment friendly files.
* <em>files {Array}</em>: the list of files to process
* <em>onComplete {Array}</em>: the function to call with the list of files</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">process: </span><span class="nf">( files, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">forAll = </span><span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span>
    <span class="nx">forAll</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">@wrap</span><span class="p">,</span> <span class="nf">() -&gt;</span>
      <span class="nv">minified = </span><span class="p">[]</span>
      <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">cssmin</span>
        <span class="nv">minified = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">files</span><span class="p">,</span> <span class="nf">( x ) -&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">x</span> <span class="p">)</span>
      <span class="nx">forAll</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">finalize</span><span class="p">,</span> <span class="nf">() -&gt;</span> 
        <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Finalizing CSS&quot;</span>
        <span class="nx">forAll</span> <span class="nx">minified</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">minify</span><span class="p">,</span> <span class="nf">() -&gt;</span> 
          <span class="k">if</span> <span class="nx">minified</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Minifying CSS&quot;</span>
          <span class="nx">forAll</span> <span class="nx">minified</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">finalize</span><span class="p">,</span> <span class="nf">() -&gt;</span> 
            <span class="nx">onComplete</span><span class="p">(</span> <span class="nx">files</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">minified</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <h2>minify</h2>

<p>Uses the cssmin lib to minify the output styles
* <em>file {String}</em>: the file to minify
* <em>onComplete {Function}</em>: the function to call after minification has completed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">minify: </span><span class="nf">( file, onComplete ) -&gt;</span>
    <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">cssmin</span>
      <span class="nx">@log</span><span class="p">.</span><span class="nx">onEvent</span> <span class="s">&quot;Minifying </span><span class="si">#{</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="si">}</span><span class="s">&quot;</span>
      <span class="nv">self = </span><span class="k">this</span>
      <span class="nv">ext = </span><span class="nx">file</span><span class="p">.</span><span class="nx">ext</span><span class="p">()</span>
      <span class="nv">newFile = </span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">ext</span><span class="p">,</span> <span class="s">&quot;.min.css&quot;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">fp</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span> 
        <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span>
        <span class="nf">( content, onTransform ) -&gt;</span>
          <span class="nx">onTransform</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">minifier</span><span class="p">.</span><span class="nx">cssmin</span> <span class="nx">content</span> <span class="p">)</span>
        <span class="p">,</span> <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">newFile</span> <span class="p">],</span>
        <span class="nf">( ) -&gt;</span>
          <span class="nv">file.name = </span><span class="nx">newFile</span>
          <span class="nx">onComplete</span><span class="p">()</span>
      <span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <h2>finalize</h2>

<p>Finalize, for lack of a better term, puts header and footer content around the file's contents.
This step is different than wrapping because it happens AFTER minification and won't get
mangled as a result.
* <em>file {String}</em>: the file to finalize
* <em>onComplete {Function}</em>: the function to call after finalization has completed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">finalize: </span><span class="nf">( file, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">finalize</span> <span class="o">and</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">finalize</span><span class="p">.</span><span class="nx">style</span>
      <span class="nx">@log</span><span class="p">.</span><span class="nx">onEvent</span> <span class="s">&quot;Finalizing </span><span class="si">#{</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="si">}</span><span class="s">&quot;</span>
      <span class="nv">header = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">finalize</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">header</span>
      <span class="nv">footer = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">finalize</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">footer</span>
      <span class="nx">@fp</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span> 
        <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span> 
        <span class="nf">( content, onTransform ) -&gt;</span>
          <span class="k">if</span> <span class="nx">header</span>
            <span class="nv">content = </span><span class="nx">header</span> <span class="o">+</span> <span class="nx">content</span>
          <span class="k">if</span> <span class="nx">footer</span>
            <span class="nv">content = </span><span class="nx">content</span> <span class="o">+</span> <span class="nx">footer</span>
          <span class="nx">onTransform</span> <span class="nx">content</span>
        <span class="p">,</span> <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span>
        <span class="nx">onComplete</span>
      <span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <h2>finalize</h2>

<p>Wraps the contents of the file with a prefix and suffix before minification occurs.
* <em>file {String}</em>: the file to wrap
* <em>onComplete {Function}</em>: the function to call after wrapping has completed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">wrap: </span><span class="nf">( file, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">wrap</span> <span class="o">and</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">wrap</span><span class="p">.</span><span class="nx">style</span>
      <span class="nx">@log</span><span class="p">.</span><span class="nx">onEvent</span> <span class="s">&quot;Wrapping </span><span class="si">#{</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="si">}</span><span class="s">&quot;</span>
      <span class="nv">prefix = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">wrap</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">prefix</span>
      <span class="nv">suffix = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">wrap</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">suffix</span>
      <span class="nx">@fp</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span> 
        <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span> 
        <span class="nf">( content, onTransform ) -&gt;</span>
          <span class="k">if</span> <span class="nx">prefix</span>
            <span class="nv">content = </span><span class="nx">prefix</span> <span class="o">+</span> <span class="nx">content</span>
          <span class="k">if</span> <span class="nx">suffix</span>
            <span class="nv">content = </span><span class="nx">content</span> <span class="o">+</span> <span class="nx">suffix</span>
          <span class="nx">onTransform</span> <span class="nx">content</span>
        <span class="p">,</span> <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span>
        <span class="nx">onComplete</span>
      <span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <h2>StylePipeline</h2>

<p>The set of post-processes that happen to completed style outputs. 
These include minification, wrapping and
finalization depending on the build configuration.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">SourcePipeline</span>

  <span class="nv">constructor: </span><span class="nf">( @config, @fp, @minifier, @scheduler, @log ) -&gt;</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <h2>process</h2>

<p>Take the list of files and minify, wrap and finalize them
according to configuration. In the event that files are minified,
this function will create a seperate set of files to separate
processing between developer friendly and deployment friendly files.
* <em>files {Array}</em>: the list of files to process
* <em>onComplete {Array}</em>: the function to call with the list of files</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">process: </span><span class="nf">( files, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">forAll = </span><span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span>
    <span class="nx">forAll</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">@wrap</span><span class="p">,</span> <span class="nf">() -&gt;</span>
      <span class="nv">minify = </span><span class="p">[]</span>
      <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">uglify</span>
        <span class="nv">minify = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">files</span><span class="p">,</span> <span class="nf">( x ) -&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">x</span> <span class="p">)</span>
      <span class="nx">forAll</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">finalize</span><span class="p">,</span> <span class="nf">() -&gt;</span> 
        <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Finalizing source files&quot;</span>
        <span class="nx">forAll</span> <span class="nx">minify</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">minify</span><span class="p">,</span> <span class="nf">() -&gt;</span> 
          <span class="k">if</span> <span class="nx">minify</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Minifying source files&quot;</span>
          <span class="nx">forAll</span> <span class="nx">minify</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">finalize</span><span class="p">,</span> <span class="nf">() -&gt;</span> 
            <span class="nx">onComplete</span><span class="p">(</span> <span class="nx">files</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">minify</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <h2>minify</h2>

<p>Uses the uglify lib to minify the output source
* <em>file {String}</em>: the file to minify
* <em>onComplete {Function}</em>: the function to call after minification has completed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">minify: </span><span class="nf">( file, onComplete ) -&gt;</span>
    <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">uglify</span>
      <span class="nv">self = </span><span class="k">this</span>
      <span class="nv">ext = </span><span class="nx">file</span><span class="p">.</span><span class="nx">ext</span><span class="p">()</span>
      <span class="nv">newFile = </span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">ext</span><span class="p">,</span> <span class="s">&quot;.min.js&quot;</span>
      <span class="nx">@log</span><span class="p">.</span><span class="nx">onEvent</span> <span class="s">&quot;Minifying </span><span class="si">#{</span> <span class="nx">newFile</span> <span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">@fp</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span> 
        <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span>
        <span class="nf">( content, onTransform ) -&gt;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">minifier</span> <span class="nx">content</span><span class="p">,</span> <span class="nf">( err, result ) -&gt;</span>
            <span class="k">if</span> <span class="nx">err</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">onError</span> <span class="s">&quot;Error minifying </span><span class="si">#{</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="si">}</span><span class="s"> : \r\n\t </span><span class="si">#{</span> <span class="nx">err</span> <span class="si">}</span><span class="s">&quot;</span>
              <span class="nv">result = </span><span class="nx">content</span>
            <span class="nx">onTransform</span><span class="p">(</span> <span class="nx">result</span> <span class="p">)</span>
        <span class="p">,</span> <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">newFile</span> <span class="p">],</span>
        <span class="nf">() -&gt;</span>
          <span class="nv">file.name = </span><span class="nx">newFile</span>
          <span class="nx">onComplete</span><span class="p">()</span>
      <span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <h2>finalize</h2>

<p>Finalize, for lack of a better term, puts header and footer content around the file's contents.
This step is different than wrapping because it happens AFTER minification and won't get
mangled as a result.
* <em>file {String}</em>: the file to finalize
* <em>onComplete {Function}</em>: the function to call after finalization has completed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">finalize: </span><span class="nf">( file, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">finalize</span> <span class="o">and</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">finalize</span><span class="p">.</span><span class="nx">source</span>
      <span class="nx">@log</span><span class="p">.</span><span class="nx">onEvent</span> <span class="s">&quot;Finalizing </span><span class="si">#{</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="si">}</span><span class="s">&quot;</span>
      <span class="nv">header = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">finalize</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">header</span>
      <span class="nv">footer = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">finalize</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">footer</span>
      <span class="nx">@fp</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span> 
        <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span> 
        <span class="nf">( content, onTransform ) -&gt;</span>
          <span class="k">if</span> <span class="nx">header</span>
            <span class="nv">content = </span><span class="nx">header</span> <span class="o">+</span> <span class="nx">content</span>
          <span class="k">if</span> <span class="nx">footer</span>
            <span class="nv">content = </span><span class="nx">content</span> <span class="o">+</span> <span class="nx">footer</span>
          <span class="nx">onTransform</span> <span class="nx">content</span>
        <span class="p">,</span> <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span>
        <span class="nf">() -&gt;</span>
          <span class="nx">onComplete</span><span class="p">()</span>
      <span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <h2>finalize</h2>

<p>Wraps the contents of the file with a prefix and suffix before minification occurs.
* <em>file {String}</em>: the file to wrap
* <em>onComplete {Function}</em>: the function to call after wrapping has completed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">wrap: </span><span class="nf">( file, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">wrap</span> <span class="o">and</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">wrap</span><span class="p">.</span><span class="nx">source</span>
      <span class="nx">@log</span><span class="p">.</span><span class="nx">onEvent</span> <span class="s">&quot;Wrapping </span><span class="si">#{</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="si">}</span><span class="s">&quot;</span>
      <span class="nv">prefix = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">wrap</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">prefix</span>
      <span class="nv">suffix = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">wrap</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">suffix</span>  
      <span class="nx">@fp</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span> 
        <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span> 
        <span class="nf">( content, onTransform ) -&gt;</span>
          <span class="k">if</span> <span class="nx">prefix</span>
            <span class="nv">content = </span><span class="nx">prefix</span> <span class="o">+</span> <span class="nx">content</span>
          <span class="k">if</span> <span class="nx">suffix</span>
            <span class="nv">content = </span><span class="nx">content</span> <span class="o">+</span> <span class="nx">suffix</span>
          <span class="nx">onTransform</span> <span class="nx">content</span>
        <span class="p">,</span> <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span>
        <span class="nf">() -&gt;</span>
          <span class="nx">onComplete</span><span class="p">()</span>
      <span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">onComplete</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <h2>MarkupPipeline</h2>

<p>Provides is a placeholder as there are currently
no post-process steps for markup.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">MarkupPipeline</span>

  <span class="nv">constructor: </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <h2>PostProcessor</h2>

<p>A provider abstraction around post-process steps for each resource
type that allows Anvil to have a 'branchless' pipeline for all 
resource types</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">PostProcessor</span>

  <span class="nv">constructor: </span><span class="nf">( @config, @fp, @scheduler, @log ) -&gt;</span>

    <span class="nv">uglify = </span><span class="nf">( source, callback ) -&gt;</span>
      <span class="k">try</span>
        <span class="nv">ast = </span><span class="nx">jsp</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">source</span>
        <span class="nv">ast = </span><span class="nx">pro</span><span class="p">.</span><span class="nx">ast_mangle</span> <span class="nx">ast</span>
        <span class="nv">ast = </span><span class="nx">pro</span><span class="p">.</span><span class="nx">ast_squeeze</span> <span class="nx">ast</span>
        <span class="nx">callback</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">pro</span><span class="p">.</span><span class="nx">gen_code</span> <span class="nx">ast</span>
      <span class="k">catch</span> <span class="nx">err</span>
        <span class="nx">callback</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&quot;&quot;</span>

    <span class="vi">@style = </span><span class="k">new</span> <span class="nx">StylePipeline</span> <span class="nx">@config</span><span class="p">,</span> <span class="nx">@fp</span><span class="p">,</span> <span class="nx">cssminifier</span><span class="p">,</span> <span class="nx">@scheduler</span><span class="p">,</span> <span class="nx">@log</span>
    <span class="vi">@source = </span><span class="k">new</span> <span class="nx">SourcePipeline</span> <span class="nx">@config</span><span class="p">,</span> <span class="nx">@fp</span><span class="p">,</span> <span class="nx">uglify</span><span class="p">,</span> <span class="nx">@scheduler</span><span class="p">,</span> <span class="nx">@log</span>
    <span class="vi">@markup = </span><span class="p">{</span>
      <span class="nv">process: </span><span class="nf">( files, onComplete ) -&gt;</span> <span class="nx">onComplete</span> <span class="nx">files</span>
    <span class="p">}</span>


<span class="nv">exports.postProcessor = </span><span class="nx">PostProcessor</span></pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p>docco --
See http://jashkenas.github.com/docco/</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">docco = </span><span class="nx">require</span> <span class="s">&quot;docco&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p>ape --
See </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">ape = </span><span class="nx">require</span> <span class="s">&quot;ape&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <h2>Documents</h2>

<p>A minor adaptation of @aaronmccall's docco and ape support
that he contributed to the prior version of Anvil.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Documenter</span>
  
  <span class="nv">constructor: </span><span class="nf">( @config, @fp, @scheduler, @log ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span>
    <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">docs</span>
      <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">docs</span><span class="p">.</span><span class="nx">generator</span> <span class="o">==</span> <span class="s">&quot;docco&quot;</span>
        <span class="vi">@generator = </span><span class="nx">@runDocco</span>
      <span class="k">else</span> 
        <span class="vi">@generator = </span><span class="nx">@runApe</span>
    <span class="k">else</span>
      <span class="vi">@generator = </span><span class="nf">() -&gt;</span> 
        <span class="nv">callback = </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="nx">callback</span>
          <span class="nx">callback</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <h2>generate</h2>

<p>Generate documents for the list of files
* <em>files {Array}</em>: the array of file objects to create documents for</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">generate: </span><span class="nf">( files ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="k">if</span> <span class="nx">files</span> <span class="o">&amp;&amp;</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">@log</span><span class="p">.</span><span class="nx">onEvent</span> <span class="s">&quot;Creating annotated source for: </span><span class="si">#{</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span> <span class="nx">files</span><span class="p">,</span> <span class="s">&#39;name&#39;</span> <span class="p">).</span><span class="nx">toString</span><span class="p">()</span> <span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">@</span><span class="nb">document</span><span class="p">,</span> <span class="nf">() -&gt;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">onComplete</span> <span class="s">&quot;Code annotation completed&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <h2>document</h2>

<p>Generate docco/ape annotated source for the combined file
Thanks much to @aaronmccall for contributing this code to Anvil!
* <em>file {String}</em>: the file object to create the document for
* <em>onComplete {Function}</em>: the function to call once the documentation is done</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nb">document</span><span class="o">:</span> <span class="nf">( file, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">language = </span><span class="nx">ape</span><span class="p">.</span><span class="nx">get_language</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span>
    <span class="nv">ext = </span><span class="nx">file</span><span class="p">.</span><span class="nx">ext</span><span class="p">()</span>
    <span class="nv">newFile = </span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">ext</span><span class="p">,</span> <span class="s">&quot;.html&quot;</span>

    <span class="nx">@log</span><span class="p">.</span><span class="nx">onEvent</span> <span class="s">&quot;Annotation for </span><span class="si">#{</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">@fp</span><span class="p">.</span><span class="nx">read</span> <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span> <span class="nf">( content ) -&gt;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">generator</span> <span class="nx">language</span><span class="p">,</span> <span class="nx">ext</span><span class="p">,</span> <span class="nx">newFile</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nf">( doc ) -&gt;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">fp</span><span class="p">.</span><span class="nx">write</span> <span class="p">[</span> <span class="nx">self</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">docs</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">newFile</span> <span class="p">],</span> <span class="nx">doc</span><span class="p">,</span> <span class="nx">onComplete</span></pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <h2>runDoco</h2>

<p>Wraps the document generation function in docco to a standard call format</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">runDocco: </span><span class="nf">( language, extension, newFile, code, onComplete ) -&gt;</span>
    <span class="nx">docco</span><span class="p">.</span><span class="nx">generate_doc_from_string</span> <span class="nx">newFile</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">extension</span><span class="p">,</span> <span class="nf">( result ) -&gt;</span> <span class="nx">onComplete</span> <span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <h2>runApe</h2>

<p>Wraps the document generation function in docco to a standard call format</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">runApe: </span><span class="nf">( language, extension, newFile, code, onComplete ) -&gt;</span>
    <span class="nx">ape</span><span class="p">.</span><span class="nx">generate_doc</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">language</span><span class="p">,</span> <span class="s">&#39;html&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nf">( err, result ) -&gt;</span> <span class="nx">onComplete</span> <span class="nx">result</span>
    </pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <h2>Anvil</h2>

<p>This provides the primary logic and flow control for build activities</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Anvil</span>

  <span class="nv">constructor: </span><span class="nf">( @config, @fp, @compiler, @combiner, @documenter, @scheduler, @postProcessor, @log, @callback ) -&gt;</span>
    <span class="nv">config = </span><span class="nx">@config</span>
    <span class="vi">@filesBuilt = </span><span class="p">{}</span>
    <span class="vi">@inProcess = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p>mini FSM - basically we don't want to start building markup until
everything else is done since markup can import other built resources</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@steps = </span>
      <span class="nv">source: </span><span class="kc">false</span>
      <span class="nv">style: </span><span class="kc">false</span>
      <span class="nv">markup: </span><span class="kc">false</span>
      <span class="nv">hasSource: </span><span class="nx">config</span><span class="p">.</span><span class="nx">source</span>
      <span class="nv">hasStyle: </span><span class="nx">config</span><span class="p">.</span><span class="nx">style</span>
      <span class="nv">hasMarkup: </span><span class="nx">config</span><span class="p">.</span><span class="nx">markup</span>
      <span class="nv">markupReady: </span><span class="nf">() -&gt;</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">source</span> <span class="o">or</span> <span class="o">not</span> <span class="k">this</span><span class="p">.</span><span class="nx">hasSource</span> <span class="p">)</span> <span class="o">and</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span> <span class="o">or</span> <span class="o">not</span> <span class="k">this</span><span class="p">.</span><span class="nx">hasStyle</span> <span class="p">)</span>
      <span class="nv">allDone: </span><span class="nf">() -&gt;</span> 
        <span class="nv">status = </span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">source</span> <span class="o">or</span> <span class="o">not</span> <span class="k">this</span><span class="p">.</span><span class="nx">hasSource</span> <span class="p">)</span> <span class="o">and</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span> <span class="o">or</span> <span class="o">not</span> <span class="k">this</span><span class="p">.</span><span class="nx">hasStyle</span> <span class="p">)</span> <span class="o">and</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">markup</span> <span class="o">or</span> <span class="o">not</span> <span class="k">this</span><span class="p">.</span><span class="nx">hasMarkup</span> <span class="p">)</span>
        <span class="nx">status</span>

  <span class="nv">extensions: </span><span class="p">[</span> <span class="s">&quot;.js&quot;</span><span class="p">,</span> <span class="s">&quot;.coffee&quot;</span><span class="p">,</span> <span class="s">&quot;.html&quot;</span><span class="p">,</span> <span class="s">&quot;.haml&quot;</span><span class="p">,</span> <span class="s">&quot;.markdown&quot;</span><span class="p">,</span> <span class="s">&quot;.md&quot;</span><span class="p">,</span> <span class="s">&quot;.css&quot;</span><span class="p">,</span> <span class="s">&quot;.styl&quot;</span><span class="p">,</span> <span class="s">&quot;.less&quot;</span><span class="p">,</span> <span class="s">&quot;.css&quot;</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <h2>build</h2>

<p>Kicks off the build for the currently configured Anvil instance</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">build: </span><span class="nf">() -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@inProcess</span>
      <span class="nx">@log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Build initiated&quot;</span>
      <span class="vi">@inProcess = </span><span class="kc">true</span>
      <span class="nx">@buildSource</span><span class="p">()</span>
      <span class="nx">@buildStyle</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <h2>buildMarkup</h2>

<p>Builds all markup sources and provides the regex patterns used to
identify dependencies using regular expressions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">buildMarkup: </span><span class="nf">() -&gt;</span>
    <span class="nv">findPatterns = </span><span class="p">[</span> <span class="sr">///[\&lt;][!][-]{2}.?import[(]?.?[&#39;\&quot;].*[&#39;\&quot;].?[)]?.?[-]{2}[\&gt;]///g</span> <span class="p">]</span>
    <span class="nv">replacePatterns = </span><span class="p">[</span> <span class="sr">///([ \t]*)[\&lt;][!][-]{2}.?import[(]?.?[&#39;\&quot;]replace[&#39;\&quot;].?[)]?.?[-]{2}[\&gt;]///g</span> <span class="p">]</span>
    <span class="nx">@processType</span><span class="p">(</span> <span class="s">&quot;markup&quot;</span><span class="p">,</span> <span class="nx">findPatterns</span><span class="p">,</span> <span class="nx">replacePatterns</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <h2>buildSource</h2>

<p>Builds all JS and Coffee sources and provides the regex patterns used to
identify dependencies using regular expressions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">buildSource: </span><span class="nf">() -&gt;</span>
    <span class="nv">findPatterns = </span><span class="p">[</span> <span class="sr">///([/]{2}|[\</span><span class="c1">#]{3}).?import.?[(]?.?[\&quot;&#39;].*[\&quot;&#39;].?[)]?[;]?.?([\#]{0,3})///g ]</span>
    <span class="sr">replacePatterns = [ ///</span><span class="p">([</span> <span class="err">\</span><span class="nx">t</span><span class="p">]</span><span class="o">*</span><span class="p">)([</span><span class="sr">/]{2}|[\#]{3}).?import.?[(]?.?[\&quot;&#39;]replace[\&quot;&#39;].?[)]?[;]?.?[\#]{0,3}/</span><span class="o">//</span><span class="nx">g</span> <span class="p">]</span>
    <span class="nx">@processType</span><span class="p">(</span> <span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="nx">findPatterns</span><span class="p">,</span> <span class="nx">replacePatterns</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <h2>buildSource</h2>

<p>Builds all CSS, LESS and Stylus sources and provides the regex patterns used to
identify dependencies using regular expressions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">buildStyle: </span><span class="nf">() -&gt;</span>
    <span class="nv">findPatterns = </span><span class="p">[</span> <span class="sr">///([/]{2}|[/][*]).?import[(]?.?[\&quot;&#39;].*[\&quot;&#39;].?[)]?([*][/])?///g</span> <span class="p">]</span>
    <span class="nv">replacePatterns = </span><span class="p">[</span> <span class="sr">///([ \t]*)([/]{2}|[/][*]).?import[(]?.?[\&quot;&#39;]replace[\&quot;&#39;].?[)]?([*][/])?///g</span> <span class="p">]</span>
    <span class="nx">@processType</span><span class="p">(</span> <span class="s">&quot;style&quot;</span><span class="p">,</span> <span class="nx">findPatterns</span><span class="p">,</span> <span class="nx">replacePatterns</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <h2>processType</h2>

<p>The steps that get followed for each resource type are the same.
This function provides the core behavior of identifying, combining,
compiling and post-processing for all the types.
* <em>type {String}</em>: ('source', 'style', 'markup') the type of resources to process
* <em>findPatterns {Regex}</em>: the list of regular expressions used to identify imports in this resource type
* <em>replacePatterns {Regex}</em>: the list of replacement regular expressions used to replace imports with file contents</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">processType: </span><span class="nf">( type, findPatterns, replacePatterns ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">forAll = </span><span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span>
    <span class="nv">compiler = </span><span class="nx">@compiler</span>
    <span class="nv">combiner = </span><span class="k">new</span> <span class="nx">@combiner</span><span class="p">(</span> <span class="nx">@fp</span><span class="p">,</span> <span class="nx">@scheduler</span><span class="p">,</span> <span class="nx">findPatterns</span><span class="p">,</span> <span class="nx">replacePatterns</span> <span class="p">)</span>
    <span class="nv">postProcessor = </span><span class="nx">@postProcessor</span>

    <span class="nx">@log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Starting </span><span class="si">#{</span> <span class="nx">type</span> <span class="si">}</span><span class="s"> pipe-line&quot;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">prepFiles</span> <span class="nx">type</span><span class="p">,</span> <span class="nf">( list ) -&gt;</span>
      <span class="k">if</span> <span class="nx">list</span> <span class="o">and</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">copyFiles</span> <span class="nx">list</span><span class="p">,</span> <span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <p>combines imported files</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Combining </span><span class="si">#{</span> <span class="nx">type</span> <span class="si">}</span><span class="s"> files&quot;</span>
          <span class="nx">combiner</span><span class="p">.</span><span class="nx">combineList</span> <span class="nx">list</span><span class="p">,</span> <span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p>filter out all files that were combined into another file</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">final = </span><span class="nx">_</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="nx">list</span><span class="p">,</span> <span class="nf">( x ) -&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">dependents</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <p>if documentation should be generated, do that now</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">docs</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">documenter</span><span class="p">.</span><span class="nx">generate</span> <span class="nx">final</span></pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <p>compiles the combined results</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Compiling </span><span class="si">#{</span> <span class="nx">type</span> <span class="si">}</span><span class="s"> files&quot;</span>
            <span class="nx">forAll</span> <span class="nx">final</span><span class="p">,</span> <span class="nx">compiler</span><span class="p">.</span><span class="nx">compile</span><span class="p">,</span> <span class="nf">( compiled ) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-163">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-163">&#182;</a>               </div>               <p>kick off post processors for compiled files</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Post-process </span><span class="si">#{</span> <span class="nx">type</span> <span class="si">}</span><span class="s"> files&quot;</span>
              <span class="nx">postProcessor</span><span class="p">[</span> <span class="nx">type</span> <span class="p">].</span><span class="nx">process</span> <span class="nx">compiled</span><span class="p">,</span> <span class="nf">( list ) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-164">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-164">&#182;</a>               </div>               <p>copy complete files to the destination folders</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">onStep</span> <span class="s">&quot;Moving </span><span class="si">#{</span> <span class="nx">type</span> <span class="si">}</span><span class="s"> files to destinations&quot;</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">finalOutput</span> <span class="nx">list</span><span class="p">,</span> <span class="nf">() -&gt;</span>
                  <span class="nx">self</span><span class="p">.</span><span class="nx">stepComplete</span> <span class="nx">type</span>
      <span class="k">else</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">stepComplete</span> <span class="nx">type</span></pre></div>             </td>           </tr>                               <tr id="section-165">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-165">&#182;</a>               </div>               <h2>finalOutput</h2>

<p>Copies the final list of files to their output folders
* <em>files {Array}</em>: the list of files to copy
* <em>onComplete {Function}</em>: the function to call once all files have been copied</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">finalOutput: </span><span class="nf">( files, onComplete ) -&gt;</span>
    <span class="nv">fp = </span><span class="nx">@fp</span>
    <span class="nv">names = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">name</span>
    <span class="nv">forAll = </span><span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span>
    <span class="nv">copy = </span><span class="nf">( file, done ) -&gt;</span>
      <span class="nx">forAll</span><span class="p">(</span> <span class="nx">file</span><span class="p">.</span><span class="nx">outputPaths</span><span class="p">,</span> <span class="nf">( destination, moved ) -&gt;</span>
        <span class="nv">outputName = </span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span>
        <span class="k">if</span> <span class="nx">names</span>
          <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">names</span> 
            <span class="nv">outputName = </span><span class="nx">names</span>
          <span class="k">else</span> 
            <span class="nv">custom = </span><span class="nx">names</span><span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">]</span>
            <span class="nv">outputName = </span><span class="nx">custom</span> <span class="o">or=</span> <span class="nx">outputName</span>
        <span class="nx">fp</span><span class="p">.</span><span class="nx">copy</span> <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span> <span class="p">[</span> <span class="nx">destination</span><span class="p">,</span> <span class="nx">outputName</span> <span class="p">],</span> <span class="nx">moved</span>
      <span class="p">,</span> <span class="nx">done</span> <span class="p">)</span>
    <span class="nx">forAll</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">copy</span><span class="p">,</span> <span class="nx">onComplete</span></pre></div>             </td>           </tr>                               <tr id="section-166">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-166">&#182;</a>               </div>               <h2>copyFiles</h2>

<p>Copies the source files to the working path before beginning any processing
* <em>files {Array}</em>: the list of files to copy
* <em>onComplete {Function}</em>: the function to call once all files have been copied</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">copyFiles: </span><span class="nf">( files, onComplete ) -&gt;</span>
    <span class="nv">fp = </span><span class="nx">@fp</span>
    <span class="nv">copy = </span><span class="nf">( file, done ) -&gt;</span> 
      <span class="nx">fp</span><span class="p">.</span><span class="nx">copy</span> <span class="nx">file</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">,</span> <span class="p">[</span> <span class="nx">file</span><span class="p">.</span><span class="nx">workingPath</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span> <span class="p">],</span> <span class="nx">done</span>
    <span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">copy</span><span class="p">,</span> <span class="nx">onComplete</span></pre></div>             </td>           </tr>                               <tr id="section-167">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-167">&#182;</a>               </div>               <h2>cleanWorking</h2>

<p>Clears all files from the working directory
* <em>onComplete {Function}</em>: the function to call after directory is cleaned</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cleanWorking: </span><span class="nf">( onComplete ) -&gt;</span>
    <span class="nv">fp = </span><span class="nx">@fp</span>
    <span class="nv">forAll = </span><span class="nx">@scheduler</span><span class="p">.</span><span class="nx">parallel</span>
    <span class="nx">fp</span><span class="p">.</span><span class="nx">getFiles</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">working</span><span class="p">,</span> <span class="nf">( files ) -&gt;</span>
      <span class="nx">forAll</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">fp</span><span class="p">.</span><span class="k">delete</span><span class="p">,</span> <span class="nx">onComplete</span></pre></div>             </td>           </tr>                               <tr id="section-168">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-168">&#182;</a>               </div>               <h2>prepFiles</h2>

<p>Determine the list of files that belong to this particular resource type
and create metadata objects that describe the file and provide necessary
metadata to the rest of the processes.
* <em>type {String}</em>: ('source', 'style', 'markup') 
* <em>onComplete {Function}</em>: the function to invoke with a completed list of file metadata</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">prepFiles: </span><span class="nf">( type, onComplete ) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">working = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">working</span>
    <span class="nv">typePath = </span><span class="nx">@config</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span>
    <span class="nv">output = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">output</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span>
    <span class="nv">output = </span><span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">output</span> <span class="p">)</span> <span class="k">then</span> <span class="nx">output</span> <span class="k">else</span> <span class="p">[</span> <span class="nx">output</span> <span class="p">]</span>
    <span class="nv">log = </span><span class="nx">@log</span>
    <span class="nx">@fp</span><span class="p">.</span><span class="nx">getFiles</span> <span class="nx">typePath</span><span class="p">,</span> <span class="nf">( files ) -&gt;</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">onEvent</span> <span class="s">&quot;Found </span><span class="si">#{</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span> <span class="si">}</span><span class="s"> </span><span class="si">#{</span> <span class="nx">type</span> <span class="si">}</span><span class="s"> files ...&quot;</span>
      <span class="nv">list = </span><span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">files</span>
            <span class="nv">name = </span><span class="nx">path</span><span class="p">.</span><span class="nx">basename</span> <span class="nx">file</span>
            <span class="p">{</span>
              <span class="nv">dependents: </span><span class="mi">0</span>
              <span class="nv">ext: </span><span class="nf">() -&gt;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">extname</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span>
              <span class="nv">fullPath: </span><span class="nx">file</span>
              <span class="nv">imports: </span><span class="p">[]</span>
              <span class="nv">name: </span><span class="nx">name</span>
              <span class="nv">originalName: </span><span class="nx">name</span>
              <span class="nv">outputPaths: </span><span class="nx">output</span>
              <span class="nv">relativePath: </span><span class="nx">file</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">typePath</span><span class="p">,</span> <span class="s">&quot;&quot;</span>
              <span class="nv">workingPath: </span><span class="nx">working</span>
            <span class="p">}</span>
      <span class="nv">filtered = </span><span class="nx">_</span><span class="p">.</span><span class="nx">filter</span> <span class="nx">list</span><span class="p">,</span> <span class="nf">( x ) -&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">any</span> <span class="nx">self</span><span class="p">.</span><span class="nx">extensions</span><span class="p">,</span> <span class="nf">( y ) -&gt;</span> <span class="nx">y</span> <span class="o">==</span> <span class="nx">x</span><span class="p">.</span><span class="nx">ext</span><span class="p">()</span>
      <span class="nx">onComplete</span> <span class="nx">filtered</span></pre></div>             </td>           </tr>                               <tr id="section-169">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-169">&#182;</a>               </div>               <h2>stepComplete</h2>

<p>Called at the end of each type's pipe-line in order to control
when markup gets built. Markup must get built last since it can include
built targets from both style and source in it's files.
* <em>step {String}</em>: ('source','style','markup')</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">stepComplete: </span><span class="nf">( step ) -&gt;</span>
    <span class="nx">@steps</span><span class="p">[</span> <span class="nx">step</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="k">if</span> <span class="nx">step</span> <span class="o">!=</span> <span class="s">&quot;markup&quot;</span> <span class="o">and</span> <span class="nx">@steps</span><span class="p">.</span><span class="nx">markupReady</span><span class="p">()</span>
      <span class="nx">@buildMarkup</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">step</span> <span class="o">==</span> <span class="s">&quot;markup&quot;</span> <span class="o">and</span> <span class="nx">@steps</span><span class="p">.</span><span class="nx">allDone</span><span class="p">()</span>
      <span class="vi">@inProcess = </span><span class="kc">false</span>
      <span class="nx">@cleanWorking</span> <span class="nx">@callback</span>
        </pre></div>             </td>           </tr>                               <tr id="section-170">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-170">&#182;</a>               </div>               <h2>Continuous</h2>

<p>Provides a way to trigger the build on file change</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Continuous</span>

  <span class="nv">constructor: </span><span class="nf">( @fp, @config, @onChange ) -&gt;</span>
    <span class="vi">@style = </span><span class="nx">@normalize</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">style</span>
    <span class="vi">@source = </span><span class="nx">@normalize</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">source</span>
    <span class="vi">@markup = </span><span class="nx">@normalize</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">markup</span>
    <span class="vi">@spec = </span><span class="nx">@normalize</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">spec</span>
    <span class="vi">@watchers = </span><span class="p">[]</span>
    <span class="vi">@watching = </span><span class="kc">false</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span>
    <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-171">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-171">&#182;</a>               </div>               <h2>normalize</h2>

<p>Takes an input and, if it is an array, returns the plain array
if the input is not an array, it turns it into a single element array
* <em>x {Object}</em>: anything</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">normalize: </span><span class="nf">( x ) -&gt;</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">x</span> <span class="k">then</span> <span class="nx">x</span> <span class="k">else</span> <span class="p">[</span> <span class="nx">x</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-172">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-172">&#182;</a>               </div>               <h2>setup</h2>

<p>Determines which directories should cause a build to trigger
if any contents change</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setup: </span><span class="nf">() -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@watching</span>
      <span class="k">if</span> <span class="nx">@style</span> <span class="k">then</span> <span class="nx">@watchPath</span> <span class="nx">p</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@style</span>
      <span class="k">if</span> <span class="nx">@source</span> <span class="k">then</span> <span class="nx">@watchPath</span> <span class="nx">p</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@source</span>
      <span class="k">if</span> <span class="nx">@markup</span> <span class="k">then</span> <span class="nx">@watchPath</span> <span class="nx">p</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@markup</span>
      <span class="k">if</span> <span class="nx">@spec</span> <span class="k">then</span> <span class="nx">@watchPath</span> <span class="nx">p</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@spec</span>

    <span class="vi">@watching = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-173">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-173">&#182;</a>               </div>               <h2>watchpath</h2>

<p>Calls watchFiles for all files in the path
* <em>path {String/Array}</em>: the path specification to watch for changes in</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">watchPath: </span><span class="nf">( path ) -&gt;</span>
    <span class="nx">@fp</span><span class="p">.</span><span class="nx">getFiles</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">@watchFiles</span></pre></div>             </td>           </tr>                               <tr id="section-174">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-174">&#182;</a>               </div>               <h2>watchFiles</h2>

<p>Creates a file watcher instance for all files in the list
* <em>files {Array}</em>: the list of files to watch for changes in</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">watchFiles: </span><span class="nf">( files ) -&gt;</span>
    <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">files</span>
      <span class="nx">@watchers</span><span class="p">.</span><span class="nx">push</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">watch</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">@onEvent</span></pre></div>             </td>           </tr>                               <tr id="section-175">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-175">&#182;</a>               </div>               <h2>onEvent</h2>

<p>This handler triggers the build and closes all watchers in the event 
of a change. This is necessary to prevent event storms that can trigger 
during the build process.
* <em>event {Object}</em>: the event that fired on the file system
* <em>file {String}</em>: the file that triggered the change</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onEvent: </span><span class="nf">( event, file ) -&gt;</span>
    <span class="vi">@watching = </span><span class="kc">false</span>
    <span class="k">while</span> <span class="nx">@watchers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">@watchers</span><span class="p">.</span><span class="nx">pop</span><span class="p">().</span><span class="nx">close</span><span class="p">()</span>
    <span class="nx">@onChange</span><span class="p">()</span>

<span class="nv">mocha = </span><span class="nx">require</span> <span class="s">&quot;mocha&quot;</span>
<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;underscore&quot;</span>
<span class="nv">reporters = </span><span class="nx">mocha</span><span class="p">.</span><span class="nx">reporters</span>
<span class="nv">interfaces = </span><span class="nx">mocha</span><span class="p">.</span><span class="nx">interfaces</span>
<span class="nv">Context = </span><span class="nx">mocha</span><span class="p">.</span><span class="nx">Context</span>
<span class="nv">Runner = </span><span class="nx">mocha</span><span class="p">.</span><span class="nx">Runner</span>
<span class="nv">Suite = </span><span class="nx">mocha</span><span class="p">.</span><span class="nx">Suite</span>
<span class="nv">path = </span><span class="nx">require</span> <span class="s">&quot;path&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-176">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-176">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">This</span> <span class="k">class</span> <span class="o">is</span> <span class="nx">an</span> <span class="nx">adaptation</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">code</span> <span class="nx">found</span> <span class="k">in</span> <span class="nx">_mocha</span>
  <span class="nx">from</span> <span class="nx">TJ</span> <span class="nx">Holowaychuk</span><span class="s">&#39;s Mocha repository:</span>
<span class="s">  https://github.com/visionmedia/mocha/blob/master/bin/_mocha</span>

<span class="s">#DIVIDER</span>
<span class="s">class MochaRunner</span>

<span class="s">  constructor: ( @fp, @scheduler, @config, @onComplete ) -&gt;</span>
<span class="s">    </span>
<span class="s">  run: () -&gt;</span>
<span class="s">    self = this</span>
<span class="s">    if @config.spec</span>
<span class="s">      forAll = @scheduler.parallel</span>
<span class="s">      filesIn = @fp.getFiles</span>

<span class="s">      opts = @config.mocha or=</span>
<span class="s">        growl: true</span>
<span class="s">        ignoreLeaks: true</span>
<span class="s">        reporter: &quot;spec&quot;</span>
<span class="s">        ui: &quot;bdd&quot;</span>
<span class="s">        colors: true</span>

<span class="s">      reporterName = opts.reporter.toLowerCase().replace( ///([a-z])///, ( x ) -&gt; x.toUpperCase() )</span>
<span class="s">      uiName = opts.ui.toLowerCase()</span>

<span class="s">      suite = new Suite &#39;&#39;, new Context</span>
<span class="s">      Base = reporters.Base</span>
<span class="s">      Reporter = reporters[reporterName]</span>
<span class="s">      ui = interfaces[uiName]( suite )</span>
<span class="s">      if opts.colors then Base.useColors = true</span>
<span class="s">      if opts.slow then Base.slow = opts.slow</span>
<span class="s">      if opts.timeout then suite.timeout opts.timeout</span>

<span class="s">      specs = if _.isString @config.spec then [ @config.spec ] else @config.spec</span>

<span class="s">      forAll specs, @fp.getFiles, ( lists ) -&gt;</span>
<span class="s">        files = _.flatten lists</span>
<span class="s">        for file in files</span>
<span class="s">          suite.emit &#39;</span><span class="nx">pre</span><span class="o">-</span><span class="nx">require</span><span class="s">&#39;, global, file</span>
<span class="s">          suite.emit &#39;</span><span class="nx">require</span><span class="s">&#39;, require file, file</span>
<span class="s">          suite.emit &#39;</span><span class="nx">post</span><span class="o">-</span><span class="nx">require</span><span class="s">&#39;, global, file</span>

<span class="s">        suite.emit &#39;</span><span class="nx">run</span><span class="s">&#39;</span>
<span class="s">        runner = new Runner suite</span>
<span class="s">        reporter = new Reporter runner</span>
<span class="s">        if opts.ignoreLeaks then runner.ignoreLeaks = true</span>
<span class="s">        runner.run () -&gt; </span>
<span class="s">          cachedFiles = _.flatten require.cache</span>
<span class="s">          sourcePath = path.resolve self.config.source</span>
<span class="s">          pathLength = sourcePath.length</span>
<span class="s">          for file in cachedFiles</span>
<span class="s">            modulePath = file.filename.substring 0, pathLength</span>
<span class="s">            if sourcePath == modulePath</span>
<span class="s">              delete require.cache[ file ]</span>
<span class="s">          self.onComplete()</span>


<span class="s">#DIVIDER</span>
<span class="s">class SocketServer</span>
<span class="s">  </span>
<span class="s">  constructor: ( app ) -&gt;</span>
<span class="s">    _.bindAll( this )</span>
<span class="s">    @clients = []</span>
<span class="s">    @io = require( &quot;socket.io&quot; ).listen(app)</span>
<span class="s">    @io.set &quot;log level&quot;, 1</span>

<span class="s">#DIVIDER</span>
<span class="s">    @io.sockets.on &quot;connection&quot;, @addClient</span>


<span class="s">#DIVIDER</span>
<span class="s">  addClient: ( socket ) -&gt;</span>
<span class="s">    @clients.push socket</span>
<span class="s">    socket.on &quot;end&quot;, @removeClient</span>
<span class="s">    socket.on &quot;disconnect&quot;, @removeClient</span>
<span class="s">    log.onEvent &quot;client connected&quot;</span>


<span class="s">#DIVIDER</span>
<span class="s">  removeClient: ( socket ) -&gt;</span>
<span class="s">    index = @clients.indexOf socket</span>
<span class="s">    @clients.splice index, 1</span>
<span class="s">    log.onEvent &quot;client disconnected&quot;</span>


<span class="s">#DIVIDER</span>
<span class="s">  refreshClients: -&gt;</span>
<span class="s">    log.onEvent &quot;Refreshing hooked clients&quot;</span>
<span class="s">    @notifyClients &quot;refresh&quot;</span>


<span class="s">#DIVIDER</span>
<span class="s">  notifyClients: ( msg ) -&gt;</span>
<span class="s">    for client in @clients</span>
<span class="s">      client.emit msg, {}</span>
<span class="s">express = require &#39;</span><span class="nx">express</span><span class="s">&#39;</span>


<span class="s">#DIVIDER</span>
<span class="s">class Host</span>

<span class="s">  constructor: ( @fp, @scheduler, @compiler, @config ) -&gt;</span>
<span class="s">    self = this</span>
<span class="s">    _.bindAll( this )</span>

<span class="s">    @app = express.createServer()</span>
<span class="s">    app = @app</span>
<span class="s">    app.use express.bodyParser()</span>
<span class="s">    app.use app.router</span>

<span class="s">    hosts = @config.hosts</span>

<span class="s">#DIVIDER</span>
<span class="s">    if hosts</span>
<span class="s">      _.each( hosts, ( value, key ) -&gt;</span>
<span class="s">        app.use key, express.static( path.resolve value )</span>
<span class="s">      )</span>

<span class="s">#DIVIDER</span>
<span class="s">    else </span>
<span class="s">      output = @config.output</span>
<span class="s">      target = &quot;&quot;</span>
<span class="s">      if @config.markup # this is a site</span>
<span class="s">        if _.isString output </span>
<span class="s">          target = output</span>
<span class="s">        else if _.isArray output</span>
<span class="s">          target = output[ 0 ]</span>
<span class="s">        else</span>
<span class="s">          target = output.markup</span>
<span class="s">      else # this is a lib</span>
<span class="s">        if _.isString output </span>
<span class="s">          target = output</span>
<span class="s">        else if _.isArray output</span>
<span class="s">          target = output[ 0 ]</span>
<span class="s">        else</span>
<span class="s">          target = output.source</span>
<span class="s">      app.use &quot;/&quot;, express.static( path.resolve target )</span>

<span class="s">    if @config.ext</span>
<span class="s">      app.use &quot;/ext&quot;, express.static( path.resolve @config.ext )</span>
<span class="s">    if @config.spec</span>
<span class="s">      app.use &quot;/spec&quot;, express.static( path.resolve @config.spec )</span>


<span class="s">#DIVIDER</span>
<span class="s">    app.get ///.*[.](coffee|kup|less|styl|md|markdown|haml)///, ( req, res ) -&gt;</span>
<span class="s">      fileName = &quot;.#{ req.url }&quot;</span>

<span class="s">      ext = path.extname fileName</span>
<span class="s">      mimeType = self.contentTypes[ ext ]</span>
<span class="s">      res.header &#39;</span><span class="nx">Content</span><span class="o">-</span><span class="nx">Type</span><span class="s">&#39;, mimeType</span>
<span class="s">      self.fp.read fileName, ( content ) -&gt;</span>
<span class="s">        self.compiler.compilers[ ext ] content, ( compiled ) -&gt;</span>
<span class="s">          res.send compiled</span>

<span class="s">    port = if @config.port then @config.port else 3080</span>
<span class="s">    app.listen port</span>

<span class="s">  contentTypes:</span>
<span class="s">    &quot;.coffee&quot;: &quot;application/javascript&quot;</span>
<span class="s">    &quot;.less&quot;: &quot;text/css&quot;</span>
<span class="s">    &quot;.styl&quot;: &quot;text/css&quot;</span>
<span class="s">    &quot;.md&quot;: &quot;text/html&quot;</span>
<span class="s">    &quot;.markdown&quot;: &quot;text/html&quot;</span>
<span class="s">    &quot;.haml&quot;: &quot;text/html&quot;</span>
<span class="s">    &quot;.kup&quot;: &quot;text/html&quot;</span>

<span class="s">#DIVIDER</span>
<span class="s">exports.run = -&gt;</span>
<span class="s">  scheduler = new Scheduler()</span>
<span class="s">  crawler = new FSCrawler( scheduler )</span>
<span class="s">  fp = new FSProvider( crawler, log )</span>
<span class="s">  configuration = new Configuration fp, scheduler, log</span>
<span class="s">  compiler = new Compiler fp, log</span>
<span class="s">  mochaRunner = undefined</span>
<span class="s">  ci = undefined</span>
<span class="s">  documenter = undefined</span>
<span class="s">  anvil = {}</span>
<span class="s">  socketServer = {}</span>
<span class="s">  fileChange = -&gt;</span>
<span class="s">  configuration.configure process.argv, ( config, stop ) -&gt;</span>
<span class="s">    if stop</span>
<span class="s">      process.exit 0</span>
<span class="s">    </span>

<span class="s">#DIVIDER</span>
<span class="s">    if config.continuous</span>
<span class="s">      ci = new Continuous fp, config, () -&gt;</span>
<span class="s">        fileChange()</span>


<span class="s">#DIVIDER</span>
<span class="s">    if config.mocha</span>
<span class="s">      mochaRunner = new MochaRunner fp, scheduler, config, () -&gt;</span>
<span class="s">        log.onComplete &quot;Tests completed&quot;</span>


<span class="s">#DIVIDER</span>
<span class="s">    if config.host</span>
<span class="s">      server = new Host fp, scheduler, compiler, config</span>
<span class="s">      socketServer = new SocketServer server.app</span>
<span class="s">      log.onStep &quot;Static HTTP server listening on port #{ config.port }&quot;</span>


<span class="s">#DIVIDER</span>
<span class="s">    postProcessor = new PostProcessor config, fp, scheduler, log</span>
<span class="s">    documenter = new Documenter config, fp, scheduler, log</span>
<span class="s">    anvil = new Anvil config, fp, compiler, Combiner, documenter, scheduler, postProcessor, log, () -&gt;</span>
<span class="s">      log.onComplete &quot;Build completed&quot;</span>
<span class="s">      if mochaRunner</span>

<span class="s">#DIVIDER</span>
<span class="s">        setTimeout( </span>
<span class="s">          () -&gt; </span>
<span class="s">            log.onStep &quot;Running specifications with Mocha&quot;</span>
<span class="s">            mochaRunner.run()</span>
<span class="s">          , 200</span>
<span class="s">        )</span>

<span class="s">      if ci</span>

<span class="s">#DIVIDER</span>
<span class="s">        setTimeout( </span>
<span class="s">          () -&gt; </span>
<span class="s">            log.onStep &quot;Initializing file watchers for CI&quot;</span>
<span class="s">            ci.setup()</span>
<span class="s">          , 200</span>
<span class="s">        )</span>

<span class="s">      if socketServer.refreshClients</span>

<span class="s">#DIVIDER</span>
<span class="s">        setTimeout(</span>
<span class="s">          () -&gt; </span>
<span class="s">            log.onStep &quot;Notifying clients of build completion&quot;</span>
<span class="s">            socketServer.refreshClients()</span>
<span class="s">          , 200</span>
<span class="s">        )</span>

<span class="s">    fileChange = -&gt; anvil.build()</span>
<span class="s">    </span>
<span class="s">    anvil.build()</span>

<span class="s">#DIVIDER</span>
<span class="s">    if ci</span>
<span class="s">      ci.setup()</span>

<span class="s">    </span>

</pre></div>             </td>           </tr>                               <tr id="section-177">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-177">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-178">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-178">&#182;</a>               </div>               <h2>SocketServer</h2>

<p>Class to manage client notifications via socket.io</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-179">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-179">&#182;</a>               </div>               <p>When a "connection" event occurs, call <em>@addClient</em></p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-180">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-180">&#182;</a>               </div>               <h2>addClient</h2>

<p>Adds a new client to be notified upon change to watched files</p>

<h3>Args:</h3>

<ul>
<li><em>socket {Object}</em>: Socket object that is generated by a socket.io 
connection event.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-181">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-181">&#182;</a>               </div>               <h2>removeClient</h2>

<p>Removes the socket from the current list of connected sockets
* <em>socket {Object}</em>: the socket that has disconnected</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-182">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-182">&#182;</a>               </div>               <h2>refreshClient</h2>

<p>Sends a 'refresh' message to all connected clients</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-183">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-183">&#182;</a>               </div>               <h2>notifyClients</h2>

<p>Send a message to all connected clients
* <em>msg {String}</em>: the message to send to connected clients</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-184">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-184">&#182;</a>               </div>               <h2>Host</h2>

<p>This class provides a simple static HTTP server
that can support all supported files types for Anvil
builds</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-185">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-185">&#182;</a>               </div>               <p>if the user told us what to do, make no assumptions
only host exactly what they specify</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-186">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-186">&#182;</a>               </div>               <p>otherwise, let's have some fun...</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-187">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-187">&#182;</a>               </div>               <p>if a static file type is requested that fits an extension we know how to
compile, use the compiler to translate it on-the-fly</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-188">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-188">&#182;</a>               </div>               <h2>run</h2>

<p>This is the function that gets exported for the CLI script.
It gets the configuration and determines how to invoke Anvil
and supporting behaviors ( CI, Host, Test runner ) based on
the configuration.
Most of the 'wierdness' in this file revolves around late binding
due to most things needing a hook to the completed config before they
can properly instantiate. If it hurts your eyes, look away :)</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-189">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-189">&#182;</a>               </div>               <p>if the user wants CI, setup the continuous module</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-190">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-190">&#182;</a>               </div>               <p>if the user wants mocha to run after the build, setup the mocha runner</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-191">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-191">&#182;</a>               </div>               <p>if the user wants hosting then, spin up the Static HTTP host and socket server</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-192">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-192">&#182;</a>               </div>               <p>create the post processor instance</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-193">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-193">&#182;</a>               </div>               <p>wrap the mocha runner invocation in a timeout call
to prevent odd timing issues.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-194">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-194">&#182;</a>               </div>               <p>wrap the CI watcher in a timeout call
to prevent odd timing issues.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-195">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-195">&#182;</a>               </div>               <p>don't notify the clients immediate after the build</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-196">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-196">&#182;</a>               </div>               <p>if we're using CI, kick it off the first time</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 
