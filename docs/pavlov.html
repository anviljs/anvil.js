<!DOCTYPE html><head><style type="text/css">pre code{display:block;padding:.5em;color:black;background:#f8f8ff}pre .comment,pre .template_comment,pre .diff .header,pre .javadoc{color:#998;font-style:italic}pre .keyword,pre .css .rule .keyword,pre .winutils,pre .javascript .title,pre .lisp .title,pre .subst{color:black;font-weight:bold}pre .number,pre .hexcolor{color:#40a070}pre .string,pre .tag .value,pre .phpdoc,pre .tex .formula{color:#d14}pre .title,pre .id{color:#900;font-weight:bold}pre .javascript .title,pre .lisp .title,pre .subst{font-weight:normal}pre .class .title,pre .haskell .label,pre .tex .command{color:#458;font-weight:bold}pre .tag,pre .tag .title,pre .rules .property,pre .django .tag .keyword{color:navy;font-weight:normal}pre .attribute,pre .variable,pre .instancevar,pre .lisp .body{color:teal}pre .regexp{color:#009926}pre .class{color:#458;font-weight:bold}pre .symbol,pre .ruby .symbol .string,pre .ruby .symbol .keyword,pre .ruby .symbol .keymethods,pre .lisp .keyword,pre .tex .special,pre .input_number{color:#990073}pre .builtin,pre .built_in,pre .lisp .title{color:#0086b3}pre .preprocessor,pre .pi,pre .doctype,pre .shebang,pre .cdata{color:#999;font-weight:bold}pre .deletion{background:#fdd}pre .addition{background:#dfd}pre .diff .change{background:#0086b3}pre .chunk{color:#aaa}pre .tex .formula{opacity:.5}#docs {margin:auto}.block {clear:both}.comment {padding: 0 10px;width:50%;background:snow}.code {width:49%;background:#f8f8ff}td {vertical-align:top}table {width:90%; border-collapse:collapse}
</style></head><body><table id="docs"><tr class="block"><td class="comment"><h2>ClientNotifier</h2>

<p>Class to manage client notifications via socket.io</p></td><td class="code"><pre><code><span class="keyword">class</span> ClientNotifier
  clients = []
</code></pre></td></tr><tr class="block"><td class="comment"><h2>init</h2>

<p>Sets up socket.io</p>

<h3>Args:</h3>

<ul>
<li><em>app {Object}</em>: the express app to integrate socket.io into</li>
</ul></td><td class="code"><pre><code>  init: <span class="params">(app)</span><span class="function">-></span>
    io = require<span class="params">(<span class="string">'socket.io'</span>)</span>.listen<span class="params">(app)</span>
    io.set <span class="string">'log level'</span>, <span class="number">1</span></code></pre></td></tr><tr class="block"><td class="comment"><p>When a 'connection' event occurs, call <em>@addClient</em></p></td><td class="code"><pre><code>    io.sockets.<span class="literal">on</span> <span class="string">'connection'</span>, @addClient
</code></pre></td></tr><tr class="block"><td class="comment"><h2>addClient</h2>

<p>Adds a new client to be notified upon change to watched files</p>

<h3>Args:</h3>

<ul>
<li><em>socket {Object}</em>: Socket object that is generated by a socket.io 
connection event.</li>
</ul></td><td class="code"><pre><code>  addClient: <span class="params">(socket)</span><span class="function">-></span>
    clients.push socket
    socket.<span class="literal">on</span> <span class="string">"end"</span>, <span class="function">-></span>
      i = clients.indexOf<span class="params">(socket)</span>
      clients.splice i, <span class="number">1</span>
</code></pre></td></tr><tr class="block"><td class="comment"><h2>notifyClients</h2>

<p>Send a "runTests" message to all connected clients.</p></td><td class="code"><pre><code>  notifyClients: <span class="function">-></span>
    onEvent <span class="string">"Notifying Browser Test Runner Clients"</span>
    i = <span class="number">0</span>

    <span class="keyword">while</span> i &lt; clients.length
      clients[i].emit <span class="string">"runTests"</span>, {}
      i++

</code></pre></td></tr><tr class="block"><td class="comment"><p>Init a new <em>ClientNotifier</em></p></td><td class="code"><pre><code>clientNotifier = <span class="keyword">new</span> ClientNotifier

</code></pre></td></tr><tr class="block"><td class="comment"><h2>createPage</h2>

<p>Creates the Pavlov testing page</p></td><td class="code"><pre><code>createPage = <span class="params">()</span><span class="function">-></span>

    specPath = config.spec <span class="keyword">or</span>= <span class="string">"./spec"</span>
    extPath = config.ext <span class="keyword">or</span>= <span class="string">"./ext"</span>
    libPath = config.testTarget

    ensurePath specPath, <span class="function">-></span>
      ensurePath extPath, <span class="function">-></span>
        spec = fs.readdirSync specPath
        spec = _.map spec, <span class="params">(x)</span> <span class="function">-></span>
            path.join specPath, x
        externals = fs.readdirSync extPath
        externals = _.map externals, <span class="params">(x)</span> <span class="function">-></span>
            path.join <span class="string">".."</span>, extPath, x
        libs = fs.readdirSync libPath
        libs = _.select libs, <span class="params">(x)</span> <span class="function">-></span>
            <span class="keyword">not</span> x.match ///[.]gz[.]/// <span class="keyword">and</span> <span class="keyword">not</span> x.match ///[.]min[.]///

        libs = _.map libs, <span class="params">(x)</span> <span class="function">-></span>
            path.join <span class="string">".."</span>, libPath, x
        list = externals.concat<span class="params">( libs )</span>.concat<span class="params">( spec )</span>

        html = builder.html
        page = html.HTML<span class="params">(
          buildHead( html, list )</span>,
          html.BODY<span class="params">(
            html.H1(
              {<span class="string">"id"</span>: <span class="string">"qunit-header"</span>},
              html.H2({<span class="string">"id"</span>:<span class="string">"qunit-banner"</span>})</span>,
              html.DIV<span class="params">({<span class="string">"id"</span>:<span class="string">"qunit-testrunner-toolbar"</span>})</span>,
              html.H2<span class="params">({<span class="string">"id"</span>:<span class="string">"qunit-userAgent"</span>})</span>,
              html.OL<span class="params">({<span class="string">"id"</span>:<span class="string">"qunit-tests"</span>})</span>
              )
          )
        )

        writeFileSync <span class="string">"index.html"</span>, page.toString<span class="params">()</span>, <span class="function">-></span>
          onEvent <span class="string">"Pavlov test page generated"</span>
          clientNotifier.notifyClients<span class="params">()</span>

</code></pre></td></tr><tr class="block"><td class="comment"><h2>buildHead</h2>

<p>Create pavlov results page HEAD by appending script tags for Pavlov, its <br />dependencies, and all Anvil output files</p>

<h3>Args:</h3>

<ul>
<li><em>html {Object}</em>: DOMBuilder.html object</li>
<li><em>list {Array}</em>: list of Anvil output files</li>
</ul></td><td class="code"><pre><code>buildHead = <span class="params">(html, list)</span><span class="function">-></span>
  pavlovDir = <span class="string">"pavlov"</span>
  qunitCSS = pavlovDir + <span class="string">"/qunit.css"</span>
  jQueryJS = pavlovDir + <span class="string">"/jquery-1.6.4.min.js"</span>
  qunitJS = pavlovDir + <span class="string">"/qunit.js"</span>
  pavlovJS = pavlovDir + <span class="string">"/pavlov.js"</span>
  socketIo = <span class="string">"/socket.io/socket.io.js"</span>
  scktHook = pavlovDir + <span class="string">"/socketHook.js"</span>

  html.HEAD<span class="params">(
    html.LINK(
      rel: <span class="string">"stylesheet"</span>
      href: qunitCSS
      type: <span class="string">"text/css"</span>
      media: <span class="string">"screen"</span>
    )</span>,
    html.SCRIPT<span class="params">(
      type: <span class="string">"text/javascript"</span>
      src: jQueryJS
    )</span>,
    html.SCRIPT<span class="params">(
      type: <span class="string">"text/javascript"</span>
      src: qunitJS
    )</span>,
    html.SCRIPT<span class="params">(
      type: <span class="string">"text/javascript"</span>
      src: pavlovJS
    )</span>,
    html.SCRIPT<span class="params">(
      type: <span class="string">"text/javascript"</span>
      src: socketIo
    )</span>,
    html.SCRIPT<span class="params">(
      type: <span class="string">"text/javascript"</span>
      src: scktHook
    )</span>,</code></pre></td></tr><tr class="block"><td class="comment"><p>see <em>buildScripts</em> below</p></td><td class="code"><pre><code>    buildScripts html, list
  )
</code></pre></td></tr><tr class="block"><td class="comment"><h2>buildScripts</h2>

<p>Generate script tags for all the files Anvil has generated</p>

<h3>Args:</h3>

<ul>
<li><em>html {Object}</em>: DOMBuilder.html object</li>
<li><em>list {Array}</em>: list of Anvil output files</li>
</ul></td><td class="code"><pre><code>buildScripts = <span class="params">( html, list )</span><span class="function">-></span></code></pre></td></tr><tr class="block"><td class="comment"><p>For each member of <em>list</em> add a new script tag to <em>html</em></p></td><td class="code"><pre><code>  _.map list, <span class="params">(x)</span> <span class="function">-></span>
    html.SCRIPT<span class="params">(
      type: <span class="string">"text/javascript"</span>
      src: x
    )</span>
</code></pre></td></tr><tr class="block"><td class="comment"><h2>hostPavlov</h2>

<p>Sets up a pavlov page at port 1580</p></td><td class="code"><pre><code>hostPavlov = <span class="params">()</span><span class="function">-></span>
    sourceBase = path.normalize path.join __dirname, <span class="string">".."</span>, <span class="string">"ext"</span>

    pavlovPath = path.join global.process.cwd<span class="params">()</span>, <span class="string">"pavlov"</span>
    <span class="keyword">try</span>
      fs.unlinkSync pavlovPath
    <span class="keyword">catch</span> error
    <span class="keyword">finally</span>
      fs.symlinkSync sourceBase, pavlovPath

    app = express.createServer<span class="params">()</span>
    app.use express.bodyParser<span class="params">()</span>
    app.use app.router

    clientNotifier.init app

    app.use <span class="string">"/"</span>, express.static<span class="params">( path.resolve(<span class="string">"."</span>)</span> )

    app.get <span class="string">"*.coffee"</span>, <span class="params">(req, res)</span> <span class="function">-></span>
        res.header <span class="string">'Content-Type'</span>, <span class="string">'application/javascript'</span>
        source = fs.readFileSync <span class="string">"."</span> + req.url, <span class="string">"utf8"</span>
        coffee = coffeeScript.compile source, { bare: <span class="literal">true</span> }
        res.send coffee

    app.listen <span class="number">1580</span></code></pre></td></tr></table></body>