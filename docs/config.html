<!DOCTYPE html><head><style type="text/css">pre code{display:block;padding:.5em;color:black;background:#f8f8ff}pre .comment,pre .template_comment,pre .diff .header,pre .javadoc{color:#998;font-style:italic}pre .keyword,pre .css .rule .keyword,pre .winutils,pre .javascript .title,pre .lisp .title,pre .subst{color:black;font-weight:bold}pre .number,pre .hexcolor{color:#40a070}pre .string,pre .tag .value,pre .phpdoc,pre .tex .formula{color:#d14}pre .title,pre .id{color:#900;font-weight:bold}pre .javascript .title,pre .lisp .title,pre .subst{font-weight:normal}pre .class .title,pre .haskell .label,pre .tex .command{color:#458;font-weight:bold}pre .tag,pre .tag .title,pre .rules .property,pre .django .tag .keyword{color:navy;font-weight:normal}pre .attribute,pre .variable,pre .instancevar,pre .lisp .body{color:teal}pre .regexp{color:#009926}pre .class{color:#458;font-weight:bold}pre .symbol,pre .ruby .symbol .string,pre .ruby .symbol .keyword,pre .ruby .symbol .keymethods,pre .lisp .keyword,pre .tex .special,pre .input_number{color:#990073}pre .builtin,pre .built_in,pre .lisp .title{color:#0086b3}pre .preprocessor,pre .pi,pre .doctype,pre .shebang,pre .cdata{color:#999;font-weight:bold}pre .deletion{background:#fdd}pre .addition{background:#dfd}pre .diff .change{background:#0086b3}pre .chunk{color:#aaa}pre .tex .formula{opacity:.5}#docs {margin:auto}.block {clear:both}.comment {padding: 0 10px;width:50%;background:snow}.code {width:49%;background:#f8f8ff}td {vertical-align:top}table {width:90%; border-collapse:collapse}
</style></head><body><table id="docs"><tr class="block"><td class="comment"><p>Configuration container</p></td><td class="code"><pre><code>config = { }
</code></pre></td></tr><tr class="block"><td class="comment"><p>Configuration defaults</p></td><td class="code"><pre><code>conventionConfig =
    <span class="string">"source"</span>: <span class="string">"src"</span>
    <span class="string">"output"</span>: <span class="string">"lib"</span>
    <span class="string">"spec"</span>: <span class="string">"spec"</span>
    <span class="string">"ext"</span>: <span class="string">"ext"</span>
    <span class="string">"lint"</span>: {}
    <span class="string">"uglify"</span>: {}
    <span class="string">"gzip"</span>: {}
    <span class="string">"gendocs"</span>: {}
    <span class="string">"hosts"</span>: {
      <span class="string">"/"</span>: <span class="string">"html"</span>
    }

continuous = test = <span class="literal">false</span>
inProcess = <span class="literal">false</span>
quiet = <span class="literal">false</span>

version = <span class="string">"0.5.5"</span>

ext =
    gzip: <span class="string">"gz"</span>
    uglify: <span class="string">"min"</span>
</code></pre></td></tr><tr class="block"><td class="comment"><h2>ensurePaths</h2>

<p>Make sure that the output and temp directories exist then call <em>callback</em></p>

<h3>Args:</h3>

<ul>
<li><em>callback {Function}</em>: what do do once we're sure that the paths exist</li>
</ul></td><td class="code"><pre><code>ensurePaths = <span class="params">(callback)</span> <span class="function">-></span>
    config.tmp = path.join config.source, <span class="string">"tmp"</span>
    ensurePath config.output, <span class="params">()</span> <span class="function">-></span>
        ensurePath config.tmp, <span class="function">-></span> callback<span class="params">()</span>
</code></pre></td></tr><tr class="block"><td class="comment"><h2>configure</h2>

<p>Do all the things!<br />Calling anvil from the command line runs this.</p></td><td class="code"><pre><code>configure = <span class="params">()</span> <span class="function">-></span></code></pre></td></tr><tr class="block"><td class="comment"><p>Setup the CLI arg parser and parse all the args</p></td><td class="code"><pre><code>    parser = <span class="keyword">new</span> ArgParser<span class="params">()</span>;
    parser.addValueOptions<span class="params">([<span class="string">"t"</span>,<span class="string">"b"</span>,<span class="string">"n"</span>,<span class="string">"html"</span>])</span>
    parser.parse<span class="params">()</span>
</code></pre></td></tr><tr class="block"><td class="comment"><p>Generate scaffold for new project?</p></td><td class="code"><pre><code>    scaffold = parser.getOptions<span class="params">(<span class="string">"n"</span>)</span></code></pre></td></tr><tr class="block"><td class="comment"><p>Make an html page with our final JS included?</p></td><td class="code"><pre><code>    htmlPage = parser.getOptions<span class="params">(<span class="string">"html"</span>)</span></code></pre></td></tr><tr class="block"><td class="comment"><p>Show version info?</p></td><td class="code"><pre><code>    showVersion = parser.getOptions<span class="params">(<span class="string">"v"</span>,<span class="string">"version"</span>)</span>

    <span class="keyword">if</span> showVersion</code></pre></td></tr><tr class="block"><td class="comment"><p>Display version info and exit</p></td><td class="code"><pre><code>        console.log <span class="string">"Anvil.js "</span> + version
        global.process.exit<span class="params">(<span class="number">0</span>)</span>
    <span class="keyword">else</span> <span class="keyword">if</span> scaffold</code></pre></td></tr><tr class="block"><td class="comment"><p>Generate all the directories and the config file</p></td><td class="code"><pre><code>      console.log <span class="string">"Creating scaffolding for "</span> + scaffold</code></pre></td></tr><tr class="block"><td class="comment"><p>Make all the paths</p></td><td class="code"><pre><code>      ensurePath scaffold, <span class="function">-></span>
        ensurePath scaffold + <span class="string">"/src"</span>, <span class="function">-></span>
          ensurePath scaffold + <span class="string">"/lib"</span>, <span class="function">-></span>
            ensurePath scaffold + <span class="string">"/ext"</span>, <span class="function">-></span>
              ensurePath scaffold + <span class="string">"/spec"</span>, <span class="function">-></span></code></pre></td></tr><tr class="block"><td class="comment"><p>Generate default config file</p></td><td class="code"><pre><code>                writeConfig scaffold + <span class="string">"/build.json"</span>
                global.process.exit<span class="params">(<span class="number">0</span>)</span>
    <span class="keyword">else</span> <span class="keyword">if</span> htmlPage</code></pre></td></tr><tr class="block"><td class="comment"><p>Create html template</p></td><td class="code"><pre><code>        generator = <span class="keyword">new</span> HtmlGenerator<span class="params">()</span>
        generator.createPageTemplate htmlPage
    <span class="keyword">else</span></code></pre></td></tr><tr class="block"><td class="comment"><p>Get build file from CLI args or use default</p></td><td class="code"><pre><code>        buildOpt = parser.getOptions<span class="params">(<span class="string">"b"</span>)</span>
        buildFile = <span class="keyword">if</span> buildOpt <span class="keyword">then</span> buildOpt <span class="keyword">else</span> <span class="string">"build.json"</span>

        onStep <span class="string">"Checking for config..."</span>
        path.exists buildFile, <span class="params">( exists )</span> <span class="function">-></span>
          prepConfig<span class="params">( exists, buildFile, ()</span> <span class="function">-></span>
</code></pre></td></tr><tr class="block"><td class="comment"><p>Get build template</p></td><td class="code"><pre><code>            buildTemplate = parser.getOptions<span class="params">(<span class="string">"t"</span>,<span class="string">"template"</span>)</span>
            <span class="keyword">if</span> buildTemplate
                output = <span class="keyword">if</span> buildTemplate == <span class="literal">true</span> <span class="keyword">then</span> <span class="string">"build.json"</span> <span class="keyword">else</span> buildTemplate
                writeConfig output
                global.process.exit<span class="params">(<span class="number">0</span>)</span>
</code></pre></td></tr><tr class="block"><td class="comment"><p>Run as CI server?</p></td><td class="code"><pre><code>            continuous = parser.getOptions<span class="params">(<span class="string">"ci"</span>)</span>
</code></pre></td></tr><tr class="block"><td class="comment"><p>Quiet mode</p></td><td class="code"><pre><code>            quiet = parser.getOptions<span class="params">(<span class="string">"q"</span>)</span>
</code></pre></td></tr><tr class="block"><td class="comment"><p>Host tests?</p></td><td class="code"><pre><code>            test = parser.getOptions<span class="params">(<span class="string">"p"</span>,<span class="string">"pavlov"</span>)</span>
            config.testTarget = config.output <span class="keyword">or</span>= <span class="string">"lib"</span>
            <span class="keyword">if</span> test
              <span class="keyword">if</span> parser.getOptions<span class="params">(<span class="string">"s"</span>)</span>
                config.testTarget = config.source <span class="keyword">or</span>= <span class="string">"src"</span>
              hostPavlov<span class="params">()</span>
</code></pre></td></tr><tr class="block"><td class="comment"><p>Host pages?</p></td><td class="code"><pre><code>            host = parser.getOptions<span class="params">(<span class="string">"h"</span>)</span>
            <span class="keyword">if</span> host
                hostStatic<span class="params">()</span></code></pre></td></tr><tr class="block"><td class="comment"><p>Run transforms and generate output</p></td><td class="code"><pre><code>            process<span class="params">()</span>
          )

</code></pre></td></tr><tr class="block"><td class="comment"><h2>prepConfig</h2>

<p>Fallback to default config, if specified config doesn't exist</p>

<h3>Args:</h3>

<ul>
<li><em>exists {Boolean}</em>: does the specified config file exist?</li>
<li><em>file {String}</em>: config file name</li>
<li><em>complete {Function}</em>: what to do after config is prepped</li>
</ul></td><td class="code"><pre><code>prepConfig = <span class="params">( exists, file, complete )</span> <span class="function">-></span>
    <span class="keyword">unless</span> exists
        loadConvention<span class="params">( complete )</span>
    <span class="keyword">else</span>
        loadConfig<span class="params">( file, complete )</span>

</code></pre></td></tr><tr class="block"><td class="comment"><h2>loadConfig</h2>

<p>Setup full configuration using specified config file <br />For example, anvil -b custom.json</p>

<h3>Args:</h3>

<ul>
<li><em>file {String}</em>: config file name</li>
<li><em>complete {Function}</em>: what to do after config is loaded</li>
</ul></td><td class="code"><pre><code>loadConfig = <span class="params">( file, complete )</span> <span class="function">-></span>
    onStep <span class="string">"Loading config..."</span>
    readFile <span class="string">"./"</span> + file,  <span class="params">( x )</span> <span class="function">-></span>
        config = JSON.parse<span class="params">( x )</span>
        <span class="keyword">if</span> config.extensions
            ext.gzip = config.extensions.gzip || ext.gzip
            ext.uglify = config.extensions.uglify || ext.uglify
</code></pre></td></tr><tr class="block"><td class="comment"><p>Setup import wrapper</p></td><td class="code"><pre><code>        <span class="keyword">if</span> config.wrapper
          <span class="keyword">if</span> config.wrapper[<span class="string">'prefix-file'</span>]
            config.wrapper.prefix = readFileSync config.wrapper[<span class="string">'prefix-file'</span>], <span class="string">'utf-8'</span>
          <span class="keyword">if</span> config.wrapper[<span class="string">'suffix-file'</span>]
            config.wrapper.suffix = readFileSync config.wrapper[<span class="string">'suffix-file'</span>], <span class="string">'utf-8'</span>
</code></pre></td></tr><tr class="block"><td class="comment"><p>Setup final output wrapper</p></td><td class="code"><pre><code>        <span class="keyword">if</span> config.finalize
          <span class="keyword">if</span> config.finalize[<span class="string">'header-file'</span>]
            config.finalize.header = fs.readFileSync config.finalize[<span class="string">'header-file'</span>], <span class="string">'utf-8'</span>
          <span class="keyword">if</span> config.finalize[<span class="string">'footer-file'</span>]
            config.finalize.footer = fs.readFileSync config.finalize[<span class="string">'footer-file'</span>], <span class="string">'utf-8'</span>
</code></pre></td></tr><tr class="block"><td class="comment"><p>Setup output file renaming</p></td><td class="code"><pre><code>        <span class="keyword">if</span> config.name
          <span class="keyword">if</span> <span class="keyword">typeof</span> config.name == <span class="string">"string"</span>
            config.getName = <span class="params">(x)</span> <span class="function">-></span> config.name
          <span class="keyword">if</span> <span class="keyword">typeof</span> config.name == <span class="string">"object"</span>
            config.getName = <span class="params">(x)</span> <span class="function">-></span> config.name[x] || config.name
          config.rename = <span class="literal">true</span>

</code></pre></td></tr><tr class="block"><td class="comment"><p>Carry on!</p></td><td class="code"><pre><code>        comp<span class="reserved">let</span>e<span class="params">()</span>

</code></pre></td></tr><tr class="block"><td class="comment"><h2>loadConvention</h2>

<p>Sets up default config if no config file is found</p>

<h3>Args:</h3>

<ul>
<li><em>complete {Function}</em>: what to do after config is setup</li>
</ul></td><td class="code"><pre><code>loadConvention = <span class="params">( complete )</span> <span class="function">-></span>
    onStep <span class="string">"Loading convention..."</span>
    config = conventionConfig
    comp<span class="reserved">let</span>e<span class="params">()</span>

</code></pre></td></tr><tr class="block"><td class="comment"><h2>writeConfig</h2>

<p>Creates new default config file</p>

<h3>Args:</h3>

<ul>
<li><em>name {String}</em>: the config file name</li>
</ul></td><td class="code"><pre><code>writeConfig = <span class="params">( name )</span> <span class="function">-></span>
    writeFileSync name, JSON.stringify<span class="params">( conventionConfig, <span class="literal">null</span>, <span class="string">"\t"</span> )</span>, <span class="params">( x )</span> <span class="function">-></span>
        onComp<span class="reserved">let</span>e <span class="string">"<span class="subst">#{name}</span> created successfully!"</span>
</code></pre></td></tr><tr class="block"><td class="comment"><p>The import detection regex</p></td><td class="code"><pre><code><span class="reserved">import</span>Regex = <span class="keyword">new</span> RegExp <span class="string">"([/].|[#])import[( ][\"].*[\"][ )][;]?([*/]{2})?"</span>, <span class="string">"g"</span></code></pre></td></tr></table></body>